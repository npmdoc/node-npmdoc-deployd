<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/deployd/deployd#readme"

    >deployd (v0.8.9)</a>
</h1>
<h4>the simplest way to build realtime APIs for web and mobile apps</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd">module deployd</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.attach">
            function <span class="apidocSignatureSpan">deployd.</span>attach
            <span class="apidocSignatureSpan">(httpServer, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context">
            function <span class="apidocSignatureSpan">deployd.</span>context
            <span class="apidocSignatureSpan">(resource, req, res, server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys">
            function <span class="apidocSignatureSpan">deployd.</span>keys
            <span class="apidocSignatureSpan">(path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource">
            function <span class="apidocSignatureSpan">deployd.</span>resource
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router">
            function <span class="apidocSignatureSpan">deployd.</span>router
            <span class="apidocSignatureSpan">(resources, server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script">
            function <span class="apidocSignatureSpan">deployd.</span>script
            <span class="apidocSignatureSpan">(src, path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server">
            function <span class="apidocSignatureSpan">deployd.</span>server
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>ayepromise</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>config_loader</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>context.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>db</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>internal_client</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>keys.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>resource.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>router.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>script.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>server.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>session</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.ayepromise">module deployd.ayepromise</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.ayepromise.defer">
            function <span class="apidocSignatureSpan">deployd.ayepromise.</span>defer
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.config_loader">module deployd.config_loader</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.config_loader.loadConfig">
            function <span class="apidocSignatureSpan">deployd.config_loader.</span>loadConfig
            <span class="apidocSignatureSpan">(basepath, server, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.context">module deployd.context</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context.context">
            function <span class="apidocSignatureSpan">deployd.</span>context
            <span class="apidocSignatureSpan">(resource, req, res, server)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.context.prototype">module deployd.context.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context.prototype.done">
            function <span class="apidocSignatureSpan">deployd.context.prototype.</span>done
            <span class="apidocSignatureSpan">(err, res)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context.prototype.end">
            function <span class="apidocSignatureSpan">deployd.context.prototype.</span>end
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.db">module deployd.db</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.db.Db">
            function <span class="apidocSignatureSpan">deployd.db.</span>Db
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.db.Store">
            function <span class="apidocSignatureSpan">deployd.db.</span>Store
            <span class="apidocSignatureSpan">(namespace, db)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.db.create">
            function <span class="apidocSignatureSpan">deployd.db.</span>create
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.internal_client">module deployd.internal_client</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.internal_client.build">
            function <span class="apidocSignatureSpan">deployd.internal_client.</span>build
            <span class="apidocSignatureSpan">(server, session, stack, ctx)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.keys">module deployd.keys</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.keys">
            function <span class="apidocSignatureSpan">deployd.</span>keys
            <span class="apidocSignatureSpan">(path)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.keys.prototype">module deployd.keys.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.create">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>create
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.generate">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>generate
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.get">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>get
            <span class="apidocSignatureSpan">(key, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.getLocal">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>getLocal
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.readFile">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>readFile
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.writeFile">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>writeFile
            <span class="apidocSignatureSpan">(data, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.resource">module deployd.resource</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.resource">
            function <span class="apidocSignatureSpan">deployd.</span>resource
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.super_">
            function <span class="apidocSignatureSpan">deployd.resource.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.toJSON">
            function <span class="apidocSignatureSpan">deployd.resource.</span>toJSON
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.resource.</span>external</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.resource.prototype">module deployd.resource.prototype</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">deployd.resource.prototype.</span>__resource__</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">deployd.resource.prototype.</span>clientGeneration</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.prototype.load">
            function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>load
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.prototype.parse">
            function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>parse
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.resource.prototype.</span>clientGenerationExec</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.resource.prototype.</span>clientGenerationGet</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.router">module deployd.router</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.router">
            function <span class="apidocSignatureSpan">deployd.</span>router
            <span class="apidocSignatureSpan">(resources, server)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.router.prototype">module deployd.router.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.prototype.generateRegex">
            function <span class="apidocSignatureSpan">deployd.router.prototype.</span>generateRegex
            <span class="apidocSignatureSpan">(path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.prototype.matchResources">
            function <span class="apidocSignatureSpan">deployd.router.prototype.</span>matchResources
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.prototype.route">
            function <span class="apidocSignatureSpan">deployd.router.prototype.</span>route
            <span class="apidocSignatureSpan">(req, res)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.script">module deployd.script</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.script">
            function <span class="apidocSignatureSpan">deployd.</span>script
            <span class="apidocSignatureSpan">(src, path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.load">
            function <span class="apidocSignatureSpan">deployd.script.</span>load
            <span class="apidocSignatureSpan">(path, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.script.prototype">module deployd.script.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.prototype.getFunction">
            function <span class="apidocSignatureSpan">deployd.script.prototype.</span>getFunction
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.prototype.run">
            function <span class="apidocSignatureSpan">deployd.script.prototype.</span>run
            <span class="apidocSignatureSpan">(ctx, domain, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.prototype.runWithContext">
            function <span class="apidocSignatureSpan">deployd.script.prototype.</span>runWithContext
            <span class="apidocSignatureSpan">(context)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.server">module deployd.server</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.server">
            function <span class="apidocSignatureSpan">deployd.</span>server
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.super_">
            function <span class="apidocSignatureSpan">deployd.server.</span>super_
            <span class="apidocSignatureSpan">(requestListener)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.server.prototype">module deployd.server.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.createStore">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>createStore
            <span class="apidocSignatureSpan">(namespace)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.handleRequest">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>handleRequest
            <span class="apidocSignatureSpan">(req, res)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.listen">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>listen
            <span class="apidocSignatureSpan">(port, host)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.route">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>route
            <span class="apidocSignatureSpan">(req, res)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.session">module deployd.session</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.session.SessionStore">
            function <span class="apidocSignatureSpan">deployd.session.</span>SessionStore
            <span class="apidocSignatureSpan">(namespace, db, sockets, options)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd" id="apidoc.module.deployd">module deployd</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.attach" id="apidoc.element.deployd.attach">
        function <span class="apidocSignatureSpan">deployd.</span>attach
        <span class="apidocSignatureSpan">(httpServer, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function attach(httpServer, options) {
  var server = process.server = httpServer;

  // defaults
  server.options = options = _.extend({
    db: {port: 27017, host: &#x27;127.0.0.1&#x27;, name: &#x27;deployd&#x27;}
  }, options);

  debug(&#x27;started with options %j&#x27;, options);

  // an object to map a server to its stores
  server.stores = {};

  // back all memory stores with a db
  server.db = db.create(options.db);

  // use socket io for a session based realtime channel
  if (options.socketIo &#x26;&#x26; options.socketIo.sockets) {
    server.sockets = options.socketIo.sockets;
  } else {
    var socketIo = require(&#x27;socket.io&#x27;).listen(server, {&#x27;log level&#x27;:0});
    server.sockets = socketIo.sockets;
  }

  // persist sessions in a store
  server.sessions = new SessionStore(&#x27;sessions&#x27;, server.db, server.sockets, options.sessions);

  // persist keys in a store
  server.keys = new Keys();

  server.handleRequest = function handleRequest(req, res) {
    // dont handle socket.io requests
    if(req.url.indexOf(&#x27;/socket.io/&#x27;) === 0) return;
    debug(&#x27;%s %s&#x27;, req.method, req.url);

    // add utilites to req and res
    setupReqRes(server.options, req, res, function(err, next) {
      if(err) return res.end(err.message);

      var authToken, usesBearerAuth = false;
      if (req.headers &#x26;&#x26; req.headers.authorization) {
        var parts = req.headers.authorization.split(&#x27; &#x27;);
        var scheme = parts[0]
        , credentials = parts[1];

        if (/^Bearer$/i.test(scheme)) {
          authToken = credentials;
          usesBearerAuth = true;
        }
      }

      server.sessions.createSession(authToken || req.cookies.get(&#x27;sid&#x27;), function(err, session) {

        if(err) {
          debug(&#x27;session error&#x27;, err, session);
          throw err;
        } else {
          if (!usesBearerAuth) {
            // (re)set the session id cookie if we&#x27;re not using Authorization Bearer
            req.cookies.set(&#x27;sid&#x27;, session.sid);
          }
          req.session = session;

          var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

          if (server.options.env === &#x27;development&#x27;) {
            if (root) {
              req.isRoot = true;
            }
            server.route(req, res);
          } else if (root) {
            // all root requests
            // must be authenticated
            debug(&#x27;authenticating&#x27;, root);
            server.keys.get(root, function(err, key) {
              if(err) throw err;
              if(key) req.isRoot = true;
              debug(&#x27;is root?&#x27;, session.isRoot);
              server.route(req, res);
            });
          } else {
            // normal route
            server.route(req, res);
          }
        }
      });
    });
  };


  var serverpath = server.options.server_dir || fs.realpathSync(&#x27;./&#x27;);

  // mkdir resourcesPath if not exists
  var resourcesPath = path.join(serverpath, &#x27;resources&#x27;);
  // use sync functions, as only run once when server start-up
  if (!fs.existsSync(resourcesPath)) {
    fs.mkdirSync(resourcesPath);
  }

  server.route = function route(req, res) {
    config.loadConfig(serverpath, server, function(err, resourcesInstances) {
      if (err) throw err;
      server.resources = resourcesInstances;
      var router = server.router = new Router(resourcesInstances, server);
      router.route(req, res);
    });
  };

  // lazy-load OR bootstrap load?
  // config.loadConfig(&#x27;./&#x27;, server, function(err, resourcesInstances) {
  //     if (err) {
  //         console.error();
  //         console.error(&#x22;Error loading resources: &#x22;);
  //         console.error(err.stack || err);
  //         process.exit(1);
  //     } else {
  //         server.resources = resourcesInstances;
  //         var router = server.router = new Router(resourcesInstances, server);
  //     }
  // });


  server.on(&#x27;request:error&#x27;, function (err, req, res) {
    console.error();
    console.error(req.method, req.url, err.stack || err);
    process.exit(1);
  });




  /**
  * Create a new `Store` for persisting data using the database info that was passed to the server when it was create ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*   var http = require(&#x27;http&#x27;);
*   var express = require(&#x27;express&#x27;);
*   var app = express();
*   var server = http.createServer(app);
*   var io = require(&#x27;socket.io&#x27;).listen(server, {&#x27;log level&#x27;: 0});
*
*   var deployd = require(&#x27;deployd&#x27;)
*   deployd.<span class="apidocCodeKeywordSpan">attach</span>(server, {socketIo: io, env: ENV, db:{host:&#x27;localhost&#x27;, port
:27015, name:&#x27;my-db&#x27;} } );
*   app.use(server.handleRequest);
*
*   server.listen();
*
* @param {Object} options
* @return {HttpServer}
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.context" id="apidoc.element.deployd.context">
        function <span class="apidocSignatureSpan">deployd.</span>context
        <span class="apidocSignatureSpan">(resource, req, res, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Context(resource, req, res, server) {
  var ctx = this;
  this.url = req.url.slice(resource.path.length).split(&#x27;?&#x27;)[0];
  if (this.url.indexOf(&#x27;/&#x27;) !== 0) this.url = &#x27;/&#x27; + this.url;

  this.req = req;
  this.res = res;
  this.body = req.body;
  this.query = req.query || {};
  this.server = server;
  this.session = req.session;
  this.method = req &#x26;&#x26; req.method;

  // always bind done to this
  var done = this.done;
  this.done = function() {
    done.apply(ctx, arguments);
  };

  if ((this.query &#x26;&#x26; typeof this.query.$limitRecursion !== &#x27;undefined&#x27;) || (this.body &#x26;&#x26; typeof this.body.$limitRecursion !== &#x27;undefined
&#x27;)) {
    var recursionLimit = this.query.$limitRecursion || this.body.$limitRecursion || 0;
    req.stack = req.stack || [];
    req.stack.recursionLimit = recursionLimit;
  }

  this.dpd = internalClient.build(server, req.session, req.stack, ctx);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys" id="apidoc.element.deployd.keys">
        function <span class="apidocSignatureSpan">deployd.</span>keys
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Keys(path) {
  this.path = path || &#x27;.dpd/keys.json&#x27;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    }
    fn(err, result);
  });
};

function loadTypes(fn) {
  _loadTypes(function(defaults, types) {
    Object.<span class="apidocCodeKeywordSpan">keys</span>(types).forEach(function(key) {
      defaults[key] = types[key];
    });
    types = defaults;
    fn(null, types);
  });
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource" id="apidoc.element.deployd.resource">
        function <span class="apidocSignatureSpan">deployd.</span>resource
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.router" id="apidoc.element.deployd.router">
        function <span class="apidocSignatureSpan">deployd.</span>router
        <span class="apidocSignatureSpan">(resources, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Router(resources, server) {
  this.resources = resources || [];
  this.server = server;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script" id="apidoc.element.deployd.script">
        function <span class="apidocSignatureSpan">deployd.</span>script
        <span class="apidocSignatureSpan">(src, path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Script(src, path) {
  this.scriptSourceCode = src;
  this.path = path;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server" id="apidoc.element.deployd.server">
        function <span class="apidocSignatureSpan">deployd.</span>server
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Server(options) {
  var server = process.server = this;
  http.Server.call(this);

  // defaults
  this.options = options = extend({
    port: 2403,
    db: {port: 27017, host: &#x27;127.0.0.1&#x27;, name: &#x27;deployd&#x27;}
  }, options);

  debug(&#x27;started with options %j&#x27;, options);

  // an object to map a server to its stores
  this.stores = {};

  // back all memory stores with a db
  this.db = db.create(options.db);

  var socketServer = io.listen(this, _.extend({
    &#x27;log level&#x27;: 0
  }, (this.options.socketIo &#x26;&#x26; this.options.socketIo.options) || {}));

  // use socket io for a session based realtime channel
  this.sockets = socketServer.sockets;

  if (this.options.socketIo &#x26;&#x26; this.options.socketIo.adapter) {
    socketServer.adapter(this.options.socketIo.adapter);
  }

  // persist sessions in a store
  this.sessions = new SessionStore(&#x27;sessions&#x27;, this.db, this.sockets, options.sessions);

  // persist keys in a store
  this.keys = new Keys();

  this.on(&#x27;request&#x27;, server.handleRequest);

  server.on(&#x27;request:error&#x27;, function (err, req, res) {
    console.error();
    console.error(req.method, req.url, err.stack || err);
    process.exit(1);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
























</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.ayepromise" id="apidoc.module.deployd.ayepromise">module deployd.ayepromise</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.ayepromise.defer" id="apidoc.element.deployd.ayepromise.defer">
        function <span class="apidocSignatureSpan">deployd.ayepromise.</span>defer
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">defer = function () {
    var state = PENDING,
        outcome,
        thenHandlers = [];

    var doSettle = function (settledState, value) {
        state = settledState;
        // persist for handlers registered after settling
        outcome = value;

        thenHandlers.forEach(function (then) {
            then.handle(state, outcome);
        });

        // Discard all references to handlers to be garbage collected
        thenHandlers = null;
    };

    var doFulfill = function (value) {
        doSettle(FULFILLED, value);
    };

    var doReject = function (error) {
        doSettle(REJECTED, error);
    };

    var registerThenHandler = function (onFulfilled, onRejected) {
        var thenHandler = aThenHandler(onFulfilled, onRejected);

        if (state === PENDING) {
            thenHandlers.push(thenHandler);
        } else {
            thenHandler.handle(state, outcome);
        }

        return thenHandler.promise;
    };

    var safelyResolveThenable = function (thenable) {
        // Either fulfill, reject or reject with error
        var onceWrapper = once();
        try {
            thenable(
                onceWrapper(transparentlyResolveThenablesAndSettle),
                onceWrapper(doReject)
            );
        } catch (e) {
            onceWrapper(doReject)(e);
        }
    };

    var transparentlyResolveThenablesAndSettle = function (value) {
        var thenable;

        try {
            thenable = getThenableIfExists(value);
        } catch (e) {
            doReject(e);
            return;
        }

        if (thenable) {
            safelyResolveThenable(thenable);
        } else {
            doFulfill(value);
        }
    };

    var onceWrapper = once();
    return {
        resolve: onceWrapper(transparentlyResolveThenablesAndSettle),
        reject: onceWrapper(doReject),
        promise: {
            then: registerThenHandler,
            fail: function (onRejected) {
                return registerThenHandler(null, onRejected);
            }
        }
    };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (typeof obj === &#x22;object&#x22; &#x26;&#x26; typeof then === &#x22;function&#x22;) {
    // Bind function back to it&#x27;s object (so fan&#x27;s of &#x27;this&#x27; don&#x27;t get sad)
    return function() { return then.apply(obj, arguments); };
}
    };

    var aThenHandler = function (onFulfilled, onRejected) {
var defer = ayepromise.<span class="apidocCodeKeywordSpan">defer</span>();

var doHandlerCall = function (func, value) {
    setTimeout(function () {
        var returnValue;
        try {
            returnValue = func(value);
        } catch (e) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.config_loader" id="apidoc.module.deployd.config_loader">module deployd.config_loader</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.config_loader.loadConfig" id="apidoc.element.deployd.config_loader.loadConfig">
        function <span class="apidocSignatureSpan">deployd.config_loader.</span>loadConfig
        <span class="apidocSignatureSpan">(basepath, server, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadConfig = function (basepath, server, fn) {
  var resources = server.__resourceCache || [];

  if (resources.length) {
    debug(&#x22;Loading from cache&#x22;);
    fn(null, resources);
    return;
  }

  var getTypes = async.memoize(loadTypes);

  async.waterfall([
      async.apply(loadResourceDir, basepath)
    , async.apply(loadResources, getTypes, basepath, server)
    , async.apply(addInternalResources, server, basepath)
  ], function(err, result) {
    if (server.options &#x26;&#x26; server.options.env !== &#x27;development&#x27;) {
      server.__resourceCache = result;
    }
    fn(err, result);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var resourcesPath = path.join(serverpath, &#x27;resources&#x27;);
// use sync functions, as only run once when server start-up
if (!fs.existsSync(resourcesPath)) {
  fs.mkdirSync(resourcesPath);
}

server.route = function route(req, res) {
  config.<span class="apidocCodeKeywordSpan">loadConfig</span>(serverpath, server, function(err, resourcesInstances) {
    if (err) throw err;
    server.resources = resourcesInstances;
    var router = server.router = new Router(resourcesInstances, server);
    router.route(req, res);
  });
};
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.context" id="apidoc.module.deployd.context">module deployd.context</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.context.context" id="apidoc.element.deployd.context.context">
        function <span class="apidocSignatureSpan">deployd.</span>context
        <span class="apidocSignatureSpan">(resource, req, res, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Context(resource, req, res, server) {
  var ctx = this;
  this.url = req.url.slice(resource.path.length).split(&#x27;?&#x27;)[0];
  if (this.url.indexOf(&#x27;/&#x27;) !== 0) this.url = &#x27;/&#x27; + this.url;

  this.req = req;
  this.res = res;
  this.body = req.body;
  this.query = req.query || {};
  this.server = server;
  this.session = req.session;
  this.method = req &#x26;&#x26; req.method;

  // always bind done to this
  var done = this.done;
  this.done = function() {
    done.apply(ctx, arguments);
  };

  if ((this.query &#x26;&#x26; typeof this.query.$limitRecursion !== &#x27;undefined&#x27;) || (this.body &#x26;&#x26; typeof this.body.$limitRecursion !== &#x27;undefined
&#x27;)) {
    var recursionLimit = this.query.$limitRecursion || this.body.$limitRecursion || 0;
    req.stack = req.stack || [];
    req.stack.recursionLimit = recursionLimit;
  }

  this.dpd = internalClient.build(server, req.session, req.stack, ctx);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.context.prototype" id="apidoc.module.deployd.context.prototype">module deployd.context.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.context.prototype.done" id="apidoc.element.deployd.context.prototype.done">
        function <span class="apidocSignatureSpan">deployd.context.prototype.</span>done
        <span class="apidocSignatureSpan">(err, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">done = function (err, res) {
  var body = res
    , type = &#x27;application/json&#x27;;

  // default response
  var status = this.res.statusCode = this.res.statusCode || 200;

  if(err) {
    debug(&#x27;%j&#x27;, err);
    if(status &#x3c; 400) this.res.statusCode = 400;
    if(err.statusCode) this.res.statusCode = err.statusCode;
    respond(err, this.req, this.res);
  } else {
    if(typeof body == &#x27;object&#x27;) {
      body = JSON.stringify(body);
    } else {
      type = &#x27;text/html; charset=utf-8&#x27;;
    }

    try {
      this.res.setHeader(&#x22;Cache-Control&#x22;, &#x22;no-cache, no-store, must-revalidate&#x22;);
      this.res.setHeader(&#x22;Pragma&#x22;, &#x22;no-cache&#x22;);
      this.res.setHeader(&#x22;Expires&#x22;, &#x22;0&#x22;);
      if(status != 204 &#x26;&#x26; status != 304) {
        if(body) {
          this.res.setHeader(&#x27;Content-Length&#x27;, Buffer.isBuffer(body)
               ? body.length
               : Buffer.byteLength(body));
        }
        this.res.setHeader(&#x27;Content-Type&#x27;, type);
        this.res.end(body);
      } else {
        this.res.end();
      }
    } catch(e) {
      console.error(e);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
   fn();
 }
};

/**
* Handle an incoming request. This gets called by the router.
* Call `next()` if the resource cannot handle the request.
* Otherwise call `cxt.<span class="apidocCodeKeywordSpan">done</span>(err, res)` when the resource
* is ready to respond.
*
* Example:
*
*  Override the handle method to return a string:
*
*     function MyResource(settings) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.context.prototype.end" id="apidoc.element.deployd.context.prototype.end">
        function <span class="apidocSignatureSpan">deployd.context.prototype.</span>end
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">end = function () {
  return this.res.end.apply(this.res, arguments);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  server.handleRequest = function handleRequest(req, res) {
    // dont handle socket.io requests
    if(req.url.indexOf(&#x27;/socket.io/&#x27;) === 0) return;
    debug(&#x27;%s %s&#x27;, req.method, req.url);

    // add utilites to req and res
    setupReqRes(server.options, req, res, function(err, next) {
if(err) return res.<span class="apidocCodeKeywordSpan">end</span>(err.message);

var authToken, usesBearerAuth = false;
if (req.headers &#x26;&#x26; req.headers.authorization) {
  var parts = req.headers.authorization.split(&#x27; &#x27;);
  var scheme = parts[0]
  , credentials = parts[1];
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.db" id="apidoc.module.deployd.db">module deployd.db</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.db.Db" id="apidoc.element.deployd.db.Db">
        function <span class="apidocSignatureSpan">deployd.db.</span>Db
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Db(options) {
  this.options = options;
  this.connectionString = this.options.connectionString;
  this.connectionOptions = this.options.connectionOptions || null;
  if (!this.connectionString &#x26;&#x26; this.options.host) {
    this.connectionString = url.format({
      protocol: &#x22;mongodb&#x22;,
      slashes: true,
      hostname: this.options.host,
      port: this.options.port,
      auth: this.options.credentials ? this.options.credentials.username + &#x22;:&#x22; + this.options.credentials.password : null,
      pathname: this.options.name
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.db.Store" id="apidoc.element.deployd.db.Store">
        function <span class="apidocSignatureSpan">deployd.db.</span>Store
        <span class="apidocSignatureSpan">(namespace, db)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Store(namespace, db) {
  this.namespace = namespace;
  this._db = db;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.db.create" id="apidoc.element.deployd.db.create">
        function <span class="apidocSignatureSpan">deployd.db.</span>create
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create = function (options) {
  var db = new Db(options);
  return db;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

debug(&#x27;started with options %j&#x27;, options);

// an object to map a server to its stores
server.stores = {};

// back all memory stores with a db
server.db = db.<span class="apidocCodeKeywordSpan">create</span>(options.db);

// use socket io for a session based realtime channel
if (options.socketIo &#x26;&#x26; options.socketIo.sockets) {
  server.sockets = options.socketIo.sockets;
} else {
  var socketIo = require(&#x27;socket.io&#x27;).listen(server, {&#x27;log level&#x27;:0});
  server.sockets = socketIo.sockets;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.internal_client" id="apidoc.module.deployd.internal_client">module deployd.internal_client</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.internal_client.build" id="apidoc.element.deployd.internal_client.build">
        function <span class="apidocSignatureSpan">deployd.internal_client.</span>build
        <span class="apidocSignatureSpan">(server, session, stack, ctx)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">build = function (server, session, stack, ctx) {
  var baseMethods
    , dpd = {};

  baseMethods = {
    request: function(method, options, fn) {
      var promise = new Promise(function(resolve, reject) {
        var req
          , res
          , urlKey
          , recursions
          , recursionLimit;

        req = {
            url: joinPath(&#x27;/&#x27;, options.path)
          , method: method
          , query: options.query
          , body: options.body
          , session: session
          , isRoot: session &#x26;&#x26; session.isRoot
          , internal: true
          , headers: (ctx &#x26;&#x26; ctx.req) ? (ctx.req.headers || {}) : {}
          , connection: (ctx &#x26;&#x26; ctx.req) ? (ctx.req.connection || {}) : {}
          , on: function() {}
        };

        var callback = function(data, error) {
          // resolve or reject promise
          if (error) {
            reject(error);
          } else {
            resolve(data);
          }
        };

        urlKey = req.method + &#x27; &#x27; + req.url;

        req.stack = stack || [];
        debug(&#x22;Stack: %j&#x22;, stack);

        recursions = req.stack.filter(function(s) { return s === urlKey; }).length;

        recursionLimit = (stack &#x26;&#x26; stack.recursionLimit) || 2;

        if (recursions &#x3c; recursionLimit) {
          req.stack.push(urlKey);
          debug(&#x22;Putting %s on stack&#x22;, urlKey);

          res = {
            setHeader: function() {},
            end: function(data) {
              if (res.statusCode === 200 || res.statusCode === 204) {
                try {
                  callback(JSON.parse(data), null);
                } catch (ex) {
                  callback(data, null);
                }
              } else {
                try {
                  callback(null, JSON.parse(data));
                } catch (ex) {
                  callback(null, data);
                }
              }
            },
            internal: true,
            headers: {},
            on: function() {}
          };

          server.router.route(req, res);
        } else {
          debug(&#x22;Recursive call detected - aborting&#x22;);
          callback(null, &#x22;Recursive call to &#x22; + urlKey + &#x22; detected&#x22;);
        }

      }).bind(this);

      if (typeof fn === &#x27;function&#x27;) {
        // call our old-style callback for backwards compatibility
        promise
          .then(function (data) {
            fn(data);
          }, function (error) {
            fn(null, error);
          });
      }

      return promise;
    }
  };

  baseMethods.get = function(options, fn) {
    return baseMethods.request.call(this, &#x22;GET&#x22;, options, fn);
  };

  baseMethods.post = function(options, fn) {
    return baseMethods.request.call(this, &#x22;POST&#x22;, options, fn);
  };

  baseMethods.put = function(options, fn) {
    return baseMethods.request.call(this, &#x22;PUT&#x22;, options, fn);
  };

  baseMethods.del = function(options, fn) {
    return baseMethods.request.call(this, &#x22;DELETE&#x22;, options, fn);
  };

  if (server.resources) {
    server.resources.forEach(function(r) {
      if (r.clientGeneration) {
        var jsName = r.path.replace(/[^A-Za-z0-9]/g, &#x27;&#x27;);
        dpd[jsName] = createResourceClient(r, baseMethods);
      }
    });
  }

  return dpd;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

if ((this.query &#x26;&#x26; typeof this.query.$limitRecursion !== &#x27;undefined&#x27;) || (this.body &#x26;&#x26; typeof this
.body.$limitRecursion !== &#x27;undefined&#x27;)) {
  var recursionLimit = this.query.$limitRecursion || this.body.$limitRecursion || 0;
  req.stack = req.stack || [];
  req.stack.recursionLimit = recursionLimit;
}

this.dpd = internalClient.<span class="apidocCodeKeywordSpan">build</span>(server, req.session, req.stack, ctx);
}

/**
 * Alias for `ctx.res.end()`
 */
Context.prototype.end = function() {
return this.res.end.apply(this.res, arguments);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.keys" id="apidoc.module.deployd.keys">module deployd.keys</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.keys.keys" id="apidoc.element.deployd.keys.keys">
        function <span class="apidocSignatureSpan">deployd.</span>keys
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Keys(path) {
  this.path = path || &#x27;.dpd/keys.json&#x27;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    }
    fn(err, result);
  });
};

function loadTypes(fn) {
  _loadTypes(function(defaults, types) {
    Object.<span class="apidocCodeKeywordSpan">keys</span>(types).forEach(function(key) {
      defaults[key] = types[key];
    });
    types = defaults;
    fn(null, types);
  });
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.keys.prototype" id="apidoc.module.deployd.keys.prototype">module deployd.keys.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.create" id="apidoc.element.deployd.keys.prototype.create">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>create
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create = function (fn) {
  var key = this.generate()
    , keys = this;

  this.readFile(function(err, data) {
    if(err) return fn(err);

    data[key] = true;
    keys.writeFile(data, function(err) {
      fn(err, key);
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

debug(&#x27;started with options %j&#x27;, options);

// an object to map a server to its stores
server.stores = {};

// back all memory stores with a db
server.db = db.<span class="apidocCodeKeywordSpan">create</span>(options.db);

// use socket io for a session based realtime channel
if (options.socketIo &#x26;&#x26; options.socketIo.sockets) {
  server.sockets = options.socketIo.sockets;
} else {
  var socketIo = require(&#x27;socket.io&#x27;).listen(server, {&#x27;log level&#x27;:0});
  server.sockets = socketIo.sockets;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.generate" id="apidoc.element.deployd.keys.prototype.generate">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>generate
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">generate = function () {
  return crypto.randomBytes(256).toString(&#x27;hex&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

/*!
 * Create a new key and save it in the keys file.
 */

Keys.prototype.create = function(fn) {
  var key = this.<span class="apidocCodeKeywordSpan">generate</span>()
, keys = this;

  this.readFile(function(err, data) {
if(err) return fn(err);

data[key] = true;
keys.writeFile(data, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.get" id="apidoc.element.deployd.keys.prototype.get">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>get
        <span class="apidocSignatureSpan">(key, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (key, fn) {
  this.readFile(function(err, data) {
    fn(err, data[key]);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

if (/^Bearer$/i.test(scheme)) {
  authToken = credentials;
  usesBearerAuth = true;
}
      }

      server.sessions.createSession(authToken || req.cookies.<span class="apidocCodeKeywordSpan">get</span>(&#x27;sid&#x27;), function
(err, session) {

if(err) {
  debug(&#x27;session error&#x27;, err, session);
  throw err;
} else {
  if (!usesBearerAuth) {
    // (re)set the session id cookie if we&#x27;re not using Authorization Bearer
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.getLocal" id="apidoc.element.deployd.keys.prototype.getLocal">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>getLocal
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getLocal = function (fn) {
  this.readFile(function(err, data) {
    if(err) return fn(err);
    if(data &#x26;&#x26; typeof data == &#x27;object&#x27;) {
      fn(null, Object.keys(data)[0]);
    } else {
      fn();
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.readFile" id="apidoc.element.deployd.keys.prototype.readFile">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>readFile
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">readFile = function (fn) {
  fs.readFile(this.path, &#x27;utf-8&#x27;, function(err, data) {
    var jsonData
      , error;

    try {
      jsonData = (data &#x26;&#x26; JSON.parse(data)) || {};
    } catch (ex) {
      error = ex;
    }

    fn(error, jsonData);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    async.auto({
types: function(fn) {
  getTypes(fn);
},

configJsonFile: function(fn) {
  debug(&#x22;reading %s&#x22;, configPath);
  fs.<span class="apidocCodeKeywordSpan">readFile</span>(configPath, &#x27;utf-8&#x27;, fn);
},

configJson: [&#x27;configJsonFile&#x27;, function(results, fn) {
  try {
    var settings = JSON.parse(results.configJsonFile);
    fn(null, settings);
  } catch (ex) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.writeFile" id="apidoc.element.deployd.keys.prototype.writeFile">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>writeFile
        <span class="apidocSignatureSpan">(data, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">writeFile = function (data, fn) {
  var str;

  try {
    str = JSON.stringify(data);
  } catch(e) {
    return fn(e);
  }

  fs.writeFile(this.path, str, fn);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 var key = this.generate()
   , keys = this;

 this.readFile(function(err, data) {
   if(err) return fn(err);

   data[key] = true;
   keys.<span class="apidocCodeKeywordSpan">writeFile</span>(data, function(err) {
     fn(err, key);
   });
 });
};

/*!
* Read the contents of the key file as JSON
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.resource" id="apidoc.module.deployd.resource">module deployd.resource</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.resource.resource" id="apidoc.element.deployd.resource.resource">
        function <span class="apidocSignatureSpan">deployd.</span>resource
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.super_" id="apidoc.element.deployd.resource.super_">
        function <span class="apidocSignatureSpan">deployd.resource.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.toJSON" id="apidoc.element.deployd.resource.toJSON">
        function <span class="apidocSignatureSpan">deployd.resource.</span>toJSON
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function () {
  return {
    type: this.name,
    defaultPath: &#x27;/my-resource&#x27;
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.resource.prototype" id="apidoc.module.deployd.resource.prototype">module deployd.resource.prototype</a></h1>






    <h2>
        <a href="#apidoc.element.deployd.resource.prototype.handle" id="apidoc.element.deployd.resource.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx, next) {
  ctx.end();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.prototype.load" id="apidoc.element.deployd.resource.prototype.load">
        function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>load
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">load = function (fn) {
  var eventNames = this.constructor &#x26;&#x26; this.constructor.events
    , remaining = eventNames &#x26;&#x26; eventNames.length
    , configPath = this.options &#x26;&#x26; this.options.configPath
    , events = this.events = {};

  if(remaining) {
    eventNames.forEach(function(e) {
      var fileName = e.toLowerCase() + &#x27;.js&#x27;
        , filePath = path.join(configPath, fileName);

      Script.load(filePath, function (err, script) {
        if (script) {
          events[e] = script;
        }
        remaining--;
        if (remaining &#x3c;= 0) {
          fn();
        }
      });
    });
  } else {
    fn();
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, fn);
}

function loadResourceExtras(resource, fn) {
async.series([
  function(fn) {
    if (resource.load) {
      resource.<span class="apidocCodeKeywordSpan">load</span>(fn);
    } else {
      fn();
    }
  }
], function(err) {
  fn(err, resource);
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.prototype.parse" id="apidoc.element.deployd.resource.prototype.parse">
        function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>parse
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">parse = function (url) {
  var parsed = parse(url, true)
    , pathname = parsed.pathname
    , parts = parsed.parts = pathname.split(&#x27;/&#x27;);

  // remove empty
  parts.shift();
  parsed.basepath = parts[0];

  // remove empty trailing slash part
  if(parts[parts.length - 1] === &#x27;&#x27;) parts.pop();

  // the last part is always the identifier
  if(parts.length &#x3e; 1) parsed.id = parts[parts.length - 1];

  if(parsed.query.q &#x26;&#x26; parsed.query.q[0] === &#x27;{&#x27; &#x26;&#x26; parsed.query.q[parsed.query.q.length - 1] === &#x27;}&#x27;) {
    parsed.query.q = JSON.parse(parsed.query.q);
  }

  return parsed;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
configJsonFile: function(fn) {
  debug(&#x22;reading %s&#x22;, configPath);
  fs.readFile(configPath, &#x27;utf-8&#x27;, fn);
},

configJson: [&#x27;configJsonFile&#x27;, function(results, fn) {
  try {
    var settings = JSON.<span class="apidocCodeKeywordSpan">parse</span>(results.configJsonFile);
    fn(null, settings);
  } catch (ex) {
    fn(ex);
  }
}],

instance: [&#x27;configJson&#x27;, &#x27;types&#x27;, function(results, fn) {
...</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.router" id="apidoc.module.deployd.router">module deployd.router</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.router.router" id="apidoc.element.deployd.router.router">
        function <span class="apidocSignatureSpan">deployd.</span>router
        <span class="apidocSignatureSpan">(resources, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Router(resources, server) {
  this.resources = resources || [];
  this.server = server;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.router.prototype" id="apidoc.module.deployd.router.prototype">module deployd.router.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.router.prototype.generateRegex" id="apidoc.element.deployd.router.prototype.generateRegex">
        function <span class="apidocSignatureSpan">deployd.router.prototype.</span>generateRegex
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">generateRegex = function (path) {
  if (!path || path === &#x27;/&#x27;) path = &#x27;&#x27;;
  path = path.replace(escapeRegExp, &#x27;\\$&#x26;&#x27;);
  return new RegExp(&#x27;^&#x27; + path + &#x27;(?:[/?].*)?$&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    , result;

  debug(&#x27;resources %j&#x27;, this.resources.map(function(r) { return r.path; }));

  if (!this.resources || !this.resources.length) return [];

  result = this.resources.filter(function(d) {
    return url.match(router.<span class="apidocCodeKeywordSpan">generateRegex</span>(d.path));
  }).sort(function(a, b) {
    return specificness(b) - specificness(a);
  });
  return result;
};

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.router.prototype.matchResources" id="apidoc.element.deployd.router.prototype.matchResources">
        function <span class="apidocSignatureSpan">deployd.router.prototype.</span>matchResources
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">matchResources = function (url) {
  var router = this
    , result;

  debug(&#x27;resources %j&#x27;, this.resources.map(function(r) { return r.path; }));

  if (!this.resources || !this.resources.length) return [];

  result = this.resources.filter(function(d) {
    return url.match(router.generateRegex(d.path));
  }).sort(function(a, b) {
    return specificness(b) - specificness(a);
  });
  return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @api public
 */

Router.prototype.route = function (req, res) {
var router = this
  , server = this.server
  , url = req.url
  , resources = this.<span class="apidocCodeKeywordSpan">matchResources</span>(url)
  , i = 0;

if (req._routed) {
  return;
}

req._routed = true;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.router.prototype.route" id="apidoc.element.deployd.router.prototype.route">
        function <span class="apidocSignatureSpan">deployd.router.prototype.</span>route
        <span class="apidocSignatureSpan">(req, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">route = function (req, res) {
  var router = this
    , server = this.server
    , url = req.url
    , resources = this.matchResources(url)
    , i = 0;

  if (req._routed) {
    return;
  }

  req._routed = true;

  async.series([function(fn) {
    async.forEach(router.resources, function(resource, fn) {
      if(resource.handleSession) {
        var ctx = new Context(resource, req, res, server);
        resource.handleSession(ctx, fn);
      } else {
        fn();
      }
    }, fn);
  }], function(err) {
    if (err) throw err;
    nextResource();
  });

  //TODO: Handle edge case where ctx.next() is called more than once
  function nextResource() {
    var resource = resources[i++]
      , ctx;

    var handler = doh.createHandler({req: req, res: res, server: server});
    handler.run(function () {
      process.nextTick(function () {
        if (resource) {
          debug(&#x27;routing %s to %s&#x27;, req.url, resource.path);
          ctx = new Context(resource, req, res, server);
          ctx.router = router;

          // default root to false
          if(ctx.session) ctx.session.isRoot = req.isRoot || false;

          // external functions
          var furl = ctx.url.replace(&#x27;/&#x27;, &#x27;&#x27;);
          if(resource.external &#x26;&#x26; resource.external[furl]) {
            resource.external[furl](ctx.body, ctx, ctx.done);
          } else {
            resource.handle(ctx, nextResource);
          }
        } else {
          debug(&#x27;404 %s&#x27;, req.url);
          res.statusCode = 404;
          error404({message: &#x27;resource not found&#x27;}, req, res);
        }
      });
    });
  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

if (server.options.env === &#x27;development&#x27;) {
  if (root) {
    req.isRoot = true;
  }
  server.<span class="apidocCodeKeywordSpan">route</span>(req, res);
} else if (root) {
  // all root requests
  // must be authenticated
  debug(&#x27;authenticating&#x27;, root);
  server.keys.get(root, function(err, key) {
    if(err) throw err;
    if(key) req.isRoot = true;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.script" id="apidoc.module.deployd.script">module deployd.script</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.script.script" id="apidoc.element.deployd.script.script">
        function <span class="apidocSignatureSpan">deployd.</span>script
        <span class="apidocSignatureSpan">(src, path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Script(src, path) {
  this.scriptSourceCode = src;
  this.path = path;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script.load" id="apidoc.element.deployd.script.load">
        function <span class="apidocSignatureSpan">deployd.script.</span>load
        <span class="apidocSignatureSpan">(path, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">load = function (path, fn) {
  fs.readFile(path, &#x27;utf-8&#x27;, function(err, val) {
    if (val) {
      fn(err, new Script(val, path));
    } else {
      fn(err);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, fn);
}

function loadResourceExtras(resource, fn) {
async.series([
  function(fn) {
    if (resource.load) {
      resource.<span class="apidocCodeKeywordSpan">load</span>(fn);
    } else {
      fn();
    }
  }
], function(err) {
  fn(err, resource);
});
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.script.prototype" id="apidoc.module.deployd.script.prototype">module deployd.script.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.script.prototype.getFunction" id="apidoc.element.deployd.script.prototype.getFunction">
        function <span class="apidocSignatureSpan">deployd.script.prototype.</span>getFunction
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getFunction = function (key) {
  var cache = memoize.cache;
  var address = &#x27;&#x27; + (hasher ? hasher.apply(this, arguments) : key);
  if (!_.has(cache, address)) cache[address] = func.apply(this, arguments);
  return cache[address];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Script.prototype.runWithContext = function (context) {
var functionArgs = Object.keys(context);

// remove the argument &#x27;this&#x27; from our list of passed arguments, because it is a reserved word
functionArgs.splice(functionArgs.indexOf(&#x27;this&#x27;), 1);

functionArgs.push(this.scriptSourceCode);
var func = this.<span class="apidocCodeKeywordSpan">getFunction</span>(functionArgs);

// pass our arguments from the sandbox to the function
var args = [];
functionArgs.forEach(function (p) {
  args.push(context[p]);
});
return func.apply(context._this || {}, args);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script.prototype.run" id="apidoc.element.deployd.script.prototype.run">
        function <span class="apidocSignatureSpan">deployd.script.prototype.</span>run
        <span class="apidocSignatureSpan">(ctx, domain, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">run = function (ctx, domain, fn) {

  if (this.error) { fn(this.error); }

  if(typeof domain === &#x27;function&#x27;) {
    fn = domain;
    domain = undefined;
  }

  var req = ctx.req
    , session = ctx.session
    , waitingForCallback = false
    , callbackCount = 0
    , isDone = false
    , events;

  var scriptContext = {
    &#x27;this&#x27;: {},
    cancel: function(msg, status) {
      var err;
      if (util.isError(msg)) {
        err = msg;
      } else if (!status &#x26;&#x26; msg &#x26;&#x26; msg.message &#x26;&#x26; (msg.status || msg.statusCode)) {
        // allow chaining this from another response
        err = {message: msg.message, statusCode: msg.status || msg.statusCode};
      } else {
        err = {message: msg, statusCode: status};
      }
      done(err);
      throw err;
    },
    cancelIf: function(condition, msg, status) {
      if (condition) {
        scriptContext.cancel(msg, status);
      }
    },
    cancelUnless: function(condition, msg, status) {
      scriptContext.cancelIf(!condition, msg, status);
    },
    me: session &#x26;&#x26; session.user,
    isMe: function(id) {
      return (scriptContext.me &#x26;&#x26; scriptContext.me.id === id) || false;
    },
    console: console,
    query: ctx.query,
    internal: req &#x26;&#x26; req.internal,
    isRoot: req &#x26;&#x26; req.session &#x26;&#x26; req.session.isRoot,
    emit: function(collection, query, event, data) {
      if(arguments.length === 4) {
        session.emitToUsers(collection, query, event, data);
      } else if(arguments.length === 3) {
        // collection is room name
        if(session.emitToRoom) session.emitToRoom(collection, query, event);
      } else if(arguments.length &#x3c;= 2) {
        event = collection;
        data = query;
        if(session.emitToAll) session.emitToAll(event, data);
      }
    },
    session: session,
    ctx: ctx
  };

  scriptContext._this = scriptContext[&#x27;this&#x27;];
  scriptContext._error = undefined;

  events = new EventEmitter();

  function done(err) {
    if (isDone) return;
    isDone = true;
    events.removeAllListeners(&#x27;finishCallback&#x27;);
    if (fn) fn(err);
  }

  if(domain) {

    events.on(&#x27;addCallback&#x27;, function() {
      waitingForCallback = true;
      callbackCount++;
    });

    events.on(&#x27;finishCallback&#x27;, function() {
      callbackCount--;
      if (callbackCount &#x3c;= 0) {
        done(scriptContext._error);
      }
    });

    events.on(&#x27;error&#x27;, function (err) {
      done(err);
    });

    domain.$addCallback = function() {
      events.emit(&#x27;addCallback&#x27;);
    };

    domain.$finishCallback = function() {
      events.emit(&#x27;finishCallback&#x27;);
    };
    domain.dpd = ctx.dpd;

    if(fn) {
      // if a callback is expected, count callbacks
      // and manually merge the domain
      wrapAsyncFunctions(domain, scriptContext, events, done);
    } else {
      // otherwise just merge the domain
      Object.keys(domain).forEach(function (key) {
        scriptContext[key] = domain[key];
      });
    }
    scriptContext[&#x27;this&#x27;] = scriptContext._this = domain.data;
  }

  var err;

  try {
    this.runWithContext(scriptContext);
  } catch(e) {
    err = wrapError(e);
    scriptContext._error = err;
  }
  err = err || scriptContext._error;
  process.nextTick(function () {
    if (!waitingForCallback &#x26;&#x26; callbackCount &#x3c;= 0) {
      done(err);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  //TODO: Handle edge case where ctx.next() is called more than once
  function nextResource() {
    var resource = resources[i++]
      , ctx;

    var handler = doh.createHandler({req: req, res: res, server: server});
    handler.<span class="apidocCodeKeywordSpan">run</span>(function () {
      process.nextTick(function () {
        if (resource) {
debug(&#x27;routing %s to %s&#x27;, req.url, resource.path);
ctx = new Context(resource, req, res, server);
ctx.router = router;

// default root to false
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script.prototype.runWithContext" id="apidoc.element.deployd.script.prototype.runWithContext">
        function <span class="apidocSignatureSpan">deployd.script.prototype.</span>runWithContext
        <span class="apidocSignatureSpan">(context)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">runWithContext = function (context) {
  var functionArgs = Object.keys(context);

  // remove the argument &#x27;this&#x27; from our list of passed arguments, because it is a reserved word
  functionArgs.splice(functionArgs.indexOf(&#x27;this&#x27;), 1);

  functionArgs.push(this.scriptSourceCode);
  var func = this.getFunction(functionArgs);

  // pass our arguments from the sandbox to the function
  var args = [];
  functionArgs.forEach(function (p) {
    args.push(context[p]);
  });
  return func.apply(context._this || {}, args);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
  scriptContext[&#x27;this&#x27;] = scriptContext._this = domain.data;
}

var err;

try {
  this.<span class="apidocCodeKeywordSpan">runWithContext</span>(scriptContext);
} catch(e) {
  err = wrapError(e);
  scriptContext._error = err;
}
err = err || scriptContext._error;
process.nextTick(function () {
  if (!waitingForCallback &#x26;&#x26; callbackCount &#x3c;= 0) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.server" id="apidoc.module.deployd.server">module deployd.server</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.server.server" id="apidoc.element.deployd.server.server">
        function <span class="apidocSignatureSpan">deployd.</span>server
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Server(options) {
  var server = process.server = this;
  http.Server.call(this);

  // defaults
  this.options = options = extend({
    port: 2403,
    db: {port: 27017, host: &#x27;127.0.0.1&#x27;, name: &#x27;deployd&#x27;}
  }, options);

  debug(&#x27;started with options %j&#x27;, options);

  // an object to map a server to its stores
  this.stores = {};

  // back all memory stores with a db
  this.db = db.create(options.db);

  var socketServer = io.listen(this, _.extend({
    &#x27;log level&#x27;: 0
  }, (this.options.socketIo &#x26;&#x26; this.options.socketIo.options) || {}));

  // use socket io for a session based realtime channel
  this.sockets = socketServer.sockets;

  if (this.options.socketIo &#x26;&#x26; this.options.socketIo.adapter) {
    socketServer.adapter(this.options.socketIo.adapter);
  }

  // persist sessions in a store
  this.sessions = new SessionStore(&#x27;sessions&#x27;, this.db, this.sockets, options.sessions);

  // persist keys in a store
  this.keys = new Keys();

  this.on(&#x27;request&#x27;, server.handleRequest);

  server.on(&#x27;request:error&#x27;, function (err, req, res) {
    console.error();
    console.error(req.method, req.url, err.stack || err);
    process.exit(1);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.super_" id="apidoc.element.deployd.server.super_">
        function <span class="apidocSignatureSpan">deployd.server.</span>super_
        <span class="apidocSignatureSpan">(requestListener)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Server(requestListener) {
  if (!(this instanceof Server)) return new Server(requestListener);
  net.Server.call(this, { allowHalfOpen: true });

  if (requestListener) {
    this.addListener(&#x27;request&#x27;, requestListener);
  }

<span class="apidocCodeCommentSpan">  /* eslint-disable max-len */
</span>  // Similar option to this. Too lazy to write my own docs.
  // http://www.squid-cache.org/Doc/config/half_closed_clients/
  // http://wiki.squid-cache.org/SquidFaq/InnerWorkings#What_is_a_half-closed_filedescriptor.3F
  /* eslint-enable max-len */
  this.httpAllowHalfOpen = false;

  this.addListener(&#x27;connection&#x27;, connectionListener);

  this.timeout = 2 * 60 * 1000;

  this._pendingResponseData = 0;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.server.prototype" id="apidoc.module.deployd.server.prototype">module deployd.server.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.server.prototype.createStore" id="apidoc.element.deployd.server.prototype.createStore">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>createStore
        <span class="apidocSignatureSpan">(namespace)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createStore = function (namespace) {
	return (this.stores[namespace] = this.db.createStore(namespace));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

/**
* Create a new `Store` for persisting data using the database info that was passed to the server when it was created.
*
* Example:
*
*     // Attach a store to the server
*     var todos = server.<span class="apidocCodeKeywordSpan">createStore</span>(&#x27;todos&#x27;);
*
*     // Use the store to CRUD data
*     todos.insert({name: &#x27;go to the store&#x27;, done: true}, ...); // see `Store` for more info
*
* @param {String} namespace
* @return {Store}
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.prototype.handleRequest" id="apidoc.element.deployd.server.prototype.handleRequest">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>handleRequest
        <span class="apidocSignatureSpan">(req, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function handleRequest(req, res) {
  var server = this;
  // dont handle socket.io requests
  if(req.url.indexOf(&#x27;/socket.io/&#x27;) === 0) return;

  debug(&#x27;%s %s&#x27;, req.method, req.url);

  // add utilites to req and res
  setupReqRes(server.options, req, res, function(err, next) {
    if(err) return res.end(err.message);

    var authToken, usesBearerAuth = false;
    if (req.headers &#x26;&#x26; req.headers.authorization) {
      var parts = req.headers.authorization.split(&#x27; &#x27;);
      var scheme = parts[0]
      , credentials = parts[1];

      if (/^Bearer$/i.test(scheme)) {
        authToken = credentials;
        usesBearerAuth = true;
      }
    }

    server.sessions.createSession(authToken || req.cookies.get(&#x27;sid&#x27;), function(err, session) {
      if(err) {
        debug(&#x27;session error&#x27;, err, session);
        throw err;
      } else {
        if (!usesBearerAuth) {
          // (re)set the session id cookie if we&#x27;re not using Authorization Bearer
          if (session.sid) req.cookies.set(&#x27;sid&#x27;, session.sid);
        }
        req.session = session;

        var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

        if (server.options.env === &#x27;development&#x27;) {
          if (root) { req.isRoot = true; }
          server.route(req, res);
        } else if (root) {
          // all root requests
          // must be authenticated
          debug(&#x27;authenticating&#x27;, root);
          server.keys.get(root, function(err, key) {
            if(err) throw err;
            if(key) req.isRoot = true;
            debug(&#x27;is root?&#x27;, session.isRoot);
            server.route(req, res);
          });
        } else {
          // normal route
          server.route(req, res);
        }
      }
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.prototype.listen" id="apidoc.element.deployd.server.prototype.listen">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>listen
        <span class="apidocSignatureSpan">(port, host)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">listen = function (port, host) {
  var server = this;
  var serverpath = server.options.server_dir || fs.realpathSync(&#x27;./&#x27;);

  config.loadConfig(serverpath, server, function(err, resourcesInstances) {
    if (err) {
      console.error();
      console.error(&#x22;Error loading resources: &#x22;);
      console.error(err.stack || err);
      process.exit(1);
    } else {
      server.resources = resourcesInstances;
      var router = new Router(resourcesInstances, server);
      server.router = router;
      http.Server.prototype.listen.call(server, port || server.options.port, host || server.options.host);
    }
  });
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*
* Example:
*
*   var http = require(&#x27;http&#x27;);
*   var express = require(&#x27;express&#x27;);
*   var app = express();
*   var server = http.createServer(app);
*   var io = require(&#x27;socket.io&#x27;).<span class="apidocCodeKeywordSpan">listen</span>(server, {&#x27;log level&#x27;: 0});
*
*   var deployd = require(&#x27;deployd&#x27;)
*   deployd.attach(server, {socketIo: io, env: ENV, db:{host:&#x27;localhost&#x27;, port:27015, name:&#x27;my-db&#x27;} } );
*   app.use(server.handleRequest);
*
*   server.listen();
*
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.prototype.route" id="apidoc.element.deployd.server.prototype.route">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>route
        <span class="apidocSignatureSpan">(req, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function route(req, res) {
  var server = this;
  var serverpath = server.options.server_dir || &#x27;./&#x27;;

  config.loadConfig(serverpath, server, function(err, resourcesInstances) {
    if (err) throw err;
    var router = new Router(resourcesInstances, server);
    server.router = router;

    server.resources = resourcesInstances;
    router.route(req, res);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

if (server.options.env === &#x27;development&#x27;) {
  if (root) {
    req.isRoot = true;
  }
  server.<span class="apidocCodeKeywordSpan">route</span>(req, res);
} else if (root) {
  // all root requests
  // must be authenticated
  debug(&#x27;authenticating&#x27;, root);
  server.keys.get(root, function(err, key) {
    if(err) throw err;
    if(key) req.isRoot = true;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.session" id="apidoc.module.deployd.session">module deployd.session</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.session.SessionStore" id="apidoc.element.deployd.session.SessionStore">
        function <span class="apidocSignatureSpan">deployd.session.</span>SessionStore
        <span class="apidocSignatureSpan">(namespace, db, sockets, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function SessionStore(namespace, db, sockets, options) {
  var self = this;

  // unique id for this store in order to identify in a cluster
  this.id = this.createUniqueIdentifier();

  this.sockets = sockets;
  this.options = options || {};
  // sessions inactive for longer than this will be cleaned up:
  this.options.maxAge = this.options.maxAge || 30 * 24 * 60 * 60 * 1000;

  if (this.options.pubClient &#x26;&#x26; this.options.subClient) {
    debug(&#x27;using pub/sub mode&#x27;);
    this.pubClient = this.options.pubClient;
    this.subClient = this.options.subClient;
  }

  // socket queue
  var socketQueue = this.socketQueue = new EventEmitter()
    , socketIndex = this.socketIndex = {};

  if (sockets) {
    if (this.subClient) {
      // subscribe to messages regarding sessions joining/leaving rooms
      // need to resync
      this.subClient.subscribe(&#x27;dpd#session#refreshrooms&#x27;);
      this.subClient.subscribe(&#x27;dpd#session#remove&#x27;);
      this.subClient.on(&#x27;message&#x27;, function(channel, message) {
        var data;
        switch (channel) {
          case &#x27;dpd#session#refreshrooms&#x27;: // another node changed rooms for a session
            data = JSON.parse(message);
            if (data.id !== self.id &#x26;&#x26; data.sid &#x26;&#x26; socketIndex[data.sid]) {
              // if we know about this session, refresh the rooms
              self.refreshSessionRooms(data.sid);
            }

            break;
          case &#x27;dpd#session#remove&#x27;: // another node removed a session
            data = JSON.parse(message);
            if (data.id !== self.id &#x26;&#x26; data.sid &#x26;&#x26; sessionIndex[data.sid]) {
              // if we know about this session, remove it from memory
              sessionIndex[data.sid]._leaveAllRooms();
              self.removeSessionFromMemory(data.sid);
            }

            break;
        }
      });
    }

    sockets.on(&#x27;connection&#x27;, function(client) {
      // NOTE: do not use set here ever, the `Cookies` api is meant to get a req, res
      // but we are just using it for a cookie parser
      var cookies = new Cookies(client.handshake)
        , sid = cookies.get(&#x27;sid&#x27;);

      var getSession = function(sid, fn) {
        // check if we already know about the session
        var session = sessionIndex[sid];
        if (session) { return fn(null, session); }
        // get the session from the store otherwise
        self.createSession(sid, function(err, session) {
          if (session.data.id === sid) return fn(null, session);
          return fn();
        });
      };

      var indexSocket = function(sid, client, session) {
        // index sockets against their session id
        socketIndex[sid] = socketIndex[sid] || {};
        socketIndex[sid][client.id] = client;
        socketQueue.emit(&#x27;socket&#x27;, client, session);

        // make sure the list of rooms to join is fresh
        self.refreshSessionRooms(sid);
      };

      if (sid) {
        getSession(sid, function(err, session) {
          if (session) {
            indexSocket(sid, client, session);
          }
        });
      }

      // Alternative way of binding session to socket connection
      // for when the sid cookie is not yet available.
      // This expects that the client emits an event with the sid.
      function setSession(data) {
        if (!data || !data.sid || typeof data.sid !== &#x27;string&#x27;) { return; }
        var sid = data.sid;

        getSession(sid, function(err, session) {
          if (session) {
            // unassign socket from previous sessions
            _.each(socketIndex, function(val) {
              delete val[client.id];
            });

            indexSocket(sid, client, session);
          }
        });
      }

      client.on(&#x27;server:setSession&#x27;, setSession);
      client.on(&#x27;server:setsession&#x27;, setSession); // allow lowercase

      client.on(&#x27;disconnect&#x27;, function() {
        // unassign socket from previous sessions
        _.each(socketIndex, function(val, sid) {
          delete val[client.id];
        });
      });
    });

    var drainQueue = function drainQueue(method, rawSocket, session) {
      var key = ...</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
