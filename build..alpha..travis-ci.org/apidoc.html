<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/deployd/deployd#readme"

    >deployd (v0.8.9)</a>
</h1>
<h4>the simplest way to build realtime APIs for web and mobile apps</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd">module deployd</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.deployd">
            function <span class="apidocSignatureSpan"></span>deployd
            <span class="apidocSignatureSpan">(config)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.attach">
            function <span class="apidocSignatureSpan">deployd.</span>attach
            <span class="apidocSignatureSpan">(httpServer, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js">
            function <span class="apidocSignatureSpan">deployd.</span>client_js
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context">
            function <span class="apidocSignatureSpan">deployd.</span>context
            <span class="apidocSignatureSpan">(resource, req, res, server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard">
            function <span class="apidocSignatureSpan">deployd.</span>dashboard
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.files">
            function <span class="apidocSignatureSpan">deployd.</span>files
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.internal_resources">
            function <span class="apidocSignatureSpan">deployd.</span>internal_resources
            <span class="apidocSignatureSpan">(settings, server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys">
            function <span class="apidocSignatureSpan">deployd.</span>keys
            <span class="apidocSignatureSpan">(path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource">
            function <span class="apidocSignatureSpan">deployd.</span>resource
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router">
            function <span class="apidocSignatureSpan">deployd.</span>router
            <span class="apidocSignatureSpan">(resources, server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script">
            function <span class="apidocSignatureSpan">deployd.</span>script
            <span class="apidocSignatureSpan">(src, path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server">
            function <span class="apidocSignatureSpan">deployd.</span>server
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection">
            function <span class="apidocSignatureSpan">deployd.</span>user_collection
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>ayepromise</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>client_js.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>config_loader</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>context.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>dashboard.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>db</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>files.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>http</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>internal_client</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>internal_resources.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>keys.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>mongod</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>resource.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>router.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>script.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>server.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>session</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>user_collection.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.</span>uuid</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.ayepromise">module deployd.ayepromise</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.ayepromise.defer">
            function <span class="apidocSignatureSpan">deployd.ayepromise.</span>defer
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.client_js">module deployd.client_js</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js.client_js">
            function <span class="apidocSignatureSpan">deployd.</span>client_js
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js.super_">
            function <span class="apidocSignatureSpan">deployd.client_js.</span>super_
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.client_js.prototype">module deployd.client_js.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js.prototype.generate">
            function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>generate
            <span class="apidocSignatureSpan">(res, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js.prototype.generateResource">
            function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>generateResource
            <span class="apidocSignatureSpan">(r, res)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.client_js.prototype.load">
            function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>load
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.config_loader">module deployd.config_loader</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.config_loader.loadConfig">
            function <span class="apidocSignatureSpan">deployd.config_loader.</span>loadConfig
            <span class="apidocSignatureSpan">(basepath, server, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.context">module deployd.context</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context.context">
            function <span class="apidocSignatureSpan">deployd.</span>context
            <span class="apidocSignatureSpan">(resource, req, res, server)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.context.prototype">module deployd.context.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context.prototype.done">
            function <span class="apidocSignatureSpan">deployd.context.prototype.</span>done
            <span class="apidocSignatureSpan">(err, res)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.context.prototype.end">
            function <span class="apidocSignatureSpan">deployd.context.prototype.</span>end
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.dashboard">module deployd.dashboard</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.dashboard">
            function <span class="apidocSignatureSpan">deployd.</span>dashboard
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.super_">
            function <span class="apidocSignatureSpan">deployd.dashboard.</span>super_
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.dashboard.prototype">module deployd.dashboard.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.loadAdvancedDashboard">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadAdvancedDashboard
            <span class="apidocSignatureSpan">(data, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.loadBasicDashboard">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadBasicDashboard
            <span class="apidocSignatureSpan">(data, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.loadLayout">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadLayout
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.loadPage">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadPage
            <span class="apidocSignatureSpan">(ctx, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.loadTypes">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadTypes
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.render">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>render
            <span class="apidocSignatureSpan">(ctx)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.dashboard.prototype.serveCustomAsset">
            function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>serveCustomAsset
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.db">module deployd.db</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.db.Db">
            function <span class="apidocSignatureSpan">deployd.db.</span>Db
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.db.Store">
            function <span class="apidocSignatureSpan">deployd.db.</span>Store
            <span class="apidocSignatureSpan">(namespace, db)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.db.create">
            function <span class="apidocSignatureSpan">deployd.db.</span>create
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.files">module deployd.files</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.files.files">
            function <span class="apidocSignatureSpan">deployd.</span>files
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.files.super_">
            function <span class="apidocSignatureSpan">deployd.files.</span>super_
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.files.prototype">module deployd.files.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.files.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.files.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.http">module deployd.http</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.http.getBody">
            function <span class="apidocSignatureSpan">deployd.http.</span>getBody
            <span class="apidocSignatureSpan">(req, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.http.parseBody">
            function <span class="apidocSignatureSpan">deployd.http.</span>parseBody
            <span class="apidocSignatureSpan">(req, res, mime, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.http.parseQuery">
            function <span class="apidocSignatureSpan">deployd.http.</span>parseQuery
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.http.redirect">
            function <span class="apidocSignatureSpan">deployd.http.</span>redirect
            <span class="apidocSignatureSpan">(res, url, statusCode)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.http.setup">
            function <span class="apidocSignatureSpan">deployd.http.</span>setup
            <span class="apidocSignatureSpan">(options, req, res, next)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.internal_client">module deployd.internal_client</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.internal_client.build">
            function <span class="apidocSignatureSpan">deployd.internal_client.</span>build
            <span class="apidocSignatureSpan">(server, session, stack, ctx)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.internal_resources">module deployd.internal_resources</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.internal_resources.internal_resources">
            function <span class="apidocSignatureSpan">deployd.</span>internal_resources
            <span class="apidocSignatureSpan">(settings, server)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.internal_resources.super_">
            function <span class="apidocSignatureSpan">deployd.internal_resources.</span>super_
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.internal_resources.prototype">module deployd.internal_resources.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.internal_resources.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.internal_resources.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.keys">module deployd.keys</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.keys">
            function <span class="apidocSignatureSpan">deployd.</span>keys
            <span class="apidocSignatureSpan">(path)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.keys.prototype">module deployd.keys.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.create">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>create
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.generate">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>generate
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.get">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>get
            <span class="apidocSignatureSpan">(key, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.getLocal">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>getLocal
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.readFile">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>readFile
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.keys.prototype.writeFile">
            function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>writeFile
            <span class="apidocSignatureSpan">(data, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.mongod">module deployd.mongod</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.mongod.restart">
            function <span class="apidocSignatureSpan">deployd.mongod.</span>restart
            <span class="apidocSignatureSpan">(mongod, env, port, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.resource">module deployd.resource</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.resource">
            function <span class="apidocSignatureSpan">deployd.</span>resource
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.super_">
            function <span class="apidocSignatureSpan">deployd.resource.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.toJSON">
            function <span class="apidocSignatureSpan">deployd.resource.</span>toJSON
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.resource.</span>external</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.resource.prototype">module deployd.resource.prototype</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">deployd.resource.prototype.</span>__resource__</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">deployd.resource.prototype.</span>clientGeneration</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.prototype.load">
            function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>load
            <span class="apidocSignatureSpan">(fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.resource.prototype.parse">
            function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>parse
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.resource.prototype.</span>clientGenerationExec</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.resource.prototype.</span>clientGenerationGet</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.router">module deployd.router</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.router">
            function <span class="apidocSignatureSpan">deployd.</span>router
            <span class="apidocSignatureSpan">(resources, server)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.router.prototype">module deployd.router.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.prototype.generateRegex">
            function <span class="apidocSignatureSpan">deployd.router.prototype.</span>generateRegex
            <span class="apidocSignatureSpan">(path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.prototype.matchResources">
            function <span class="apidocSignatureSpan">deployd.router.prototype.</span>matchResources
            <span class="apidocSignatureSpan">(url)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.router.prototype.route">
            function <span class="apidocSignatureSpan">deployd.router.prototype.</span>route
            <span class="apidocSignatureSpan">(req, res)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.script">module deployd.script</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.script">
            function <span class="apidocSignatureSpan">deployd.</span>script
            <span class="apidocSignatureSpan">(src, path)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.load">
            function <span class="apidocSignatureSpan">deployd.script.</span>load
            <span class="apidocSignatureSpan">(path, fn)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.script.prototype">module deployd.script.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.prototype.getFunction">
            function <span class="apidocSignatureSpan">deployd.script.prototype.</span>getFunction
            <span class="apidocSignatureSpan">(key)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.prototype.run">
            function <span class="apidocSignatureSpan">deployd.script.prototype.</span>run
            <span class="apidocSignatureSpan">(ctx, domain, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.script.prototype.runWithContext">
            function <span class="apidocSignatureSpan">deployd.script.prototype.</span>runWithContext
            <span class="apidocSignatureSpan">(context)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.server">module deployd.server</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.server">
            function <span class="apidocSignatureSpan">deployd.</span>server
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.super_">
            function <span class="apidocSignatureSpan">deployd.server.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.server.prototype">module deployd.server.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.createStore">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>createStore
            <span class="apidocSignatureSpan">(namespace)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.handleRequest">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>handleRequest
            <span class="apidocSignatureSpan">(req, res)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.listen">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>listen
            <span class="apidocSignatureSpan">(port, host)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.server.prototype.route">
            function <span class="apidocSignatureSpan">deployd.server.prototype.</span>route
            <span class="apidocSignatureSpan">(req, res)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.session">module deployd.session</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.session.SessionStore">
            function <span class="apidocSignatureSpan">deployd.session.</span>SessionStore
            <span class="apidocSignatureSpan">(namespace, db, sockets, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.user_collection">module deployd.user_collection</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.user_collection">
            function <span class="apidocSignatureSpan">deployd.</span>user_collection
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.super_">
            function <span class="apidocSignatureSpan">deployd.user_collection.</span>super_
            <span class="apidocSignatureSpan">(name, options)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">deployd.user_collection.</span>SALT_LEN</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.user_collection.</span>dashboard</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.user_collection.</span>events</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">deployd.user_collection.</span>defaultPath</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">string <span class="apidocSignatureSpan">deployd.user_collection.</span>label</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.user_collection.prototype">module deployd.user_collection.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.checkHash">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>checkHash
            <span class="apidocSignatureSpan">(uc, user, credentials)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.getUserAndPasswordHash">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>getUserAndPasswordHash
            <span class="apidocSignatureSpan">(user)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.handle">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>handle
            <span class="apidocSignatureSpan">(ctx)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.handleLogin">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>handleLogin
            <span class="apidocSignatureSpan">(ctx)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.handleSession">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>handleSession
            <span class="apidocSignatureSpan">(ctx, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.hash">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>hash
            <span class="apidocSignatureSpan">(password, salt)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.loginFindUser">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>loginFindUser
            <span class="apidocSignatureSpan">(ctx, fn)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.setPassword">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>setPassword
            <span class="apidocSignatureSpan">(body)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.user_collection.prototype.setSessionId">
            function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>setSessionId
            <span class="apidocSignatureSpan">(ctx, sessionId)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>clientGenerationExec</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>clientGenerationGet</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.deployd.uuid">module deployd.uuid</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.deployd.uuid.create">
            function <span class="apidocSignatureSpan">deployd.uuid.</span>create
            <span class="apidocSignatureSpan">(length)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd" id="apidoc.module.deployd">module deployd</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.deployd" id="apidoc.element.deployd.deployd">
        function <span class="apidocSignatureSpan"></span>deployd
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">deployd = function (config) {
  var server = new Server(config);
  upgrade(server);
  return server;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.attach" id="apidoc.element.deployd.attach">
        function <span class="apidocSignatureSpan">deployd.</span>attach
        <span class="apidocSignatureSpan">(httpServer, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function attach(httpServer, options) {
  var server = process.server = httpServer;

  // defaults
  server.options = options = _.extend({
    db: {port: 27017, host: &#x27;127.0.0.1&#x27;, name: &#x27;deployd&#x27;}
  }, options);

  debug(&#x27;started with options %j&#x27;, options);

  // an object to map a server to its stores
  server.stores = {};

  // back all memory stores with a db
  server.db = db.create(options.db);

  // use socket io for a session based realtime channel
  if (options.socketIo &#x26;&#x26; options.socketIo.sockets) {
    server.sockets = options.socketIo.sockets;
  } else {
    var socketIo = require(&#x27;socket.io&#x27;).listen(server, {&#x27;log level&#x27;:0});
    server.sockets = socketIo.sockets;
  }

  // persist sessions in a store
  server.sessions = new SessionStore(&#x27;sessions&#x27;, server.db, server.sockets, options.sessions);

  // persist keys in a store
  server.keys = new Keys();

  server.handleRequest = function handleRequest(req, res) {
    // dont handle socket.io requests
    if(req.url.indexOf(&#x27;/socket.io/&#x27;) === 0) return;
    debug(&#x27;%s %s&#x27;, req.method, req.url);

    // add utilites to req and res
    setupReqRes(server.options, req, res, function(err, next) {
      if(err) return res.end(err.message);

      var authToken, usesBearerAuth = false;
      if (req.headers &#x26;&#x26; req.headers.authorization) {
        var parts = req.headers.authorization.split(&#x27; &#x27;);
        var scheme = parts[0]
        , credentials = parts[1];

        if (/^Bearer$/i.test(scheme)) {
          authToken = credentials;
          usesBearerAuth = true;
        }
      }

      server.sessions.createSession(authToken || req.cookies.get(&#x27;sid&#x27;), function(err, session) {

        if(err) {
          debug(&#x27;session error&#x27;, err, session);
          throw err;
        } else {
          if (!usesBearerAuth) {
            // (re)set the session id cookie if we&#x27;re not using Authorization Bearer
            req.cookies.set(&#x27;sid&#x27;, session.sid);
          }
          req.session = session;

          var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

          if (server.options.env === &#x27;development&#x27;) {
            if (root) {
              req.isRoot = true;
            }
            server.route(req, res);
          } else if (root) {
            // all root requests
            // must be authenticated
            debug(&#x27;authenticating&#x27;, root);
            server.keys.get(root, function(err, key) {
              if(err) throw err;
              if(key) req.isRoot = true;
              debug(&#x27;is root?&#x27;, session.isRoot);
              server.route(req, res);
            });
          } else {
            // normal route
            server.route(req, res);
          }
        }
      });
    });
  };


  var serverpath = server.options.server_dir || fs.realpathSync(&#x27;./&#x27;);

  // mkdir resourcesPath if not exists
  var resourcesPath = path.join(serverpath, &#x27;resources&#x27;);
  // use sync functions, as only run once when server start-up
  if (!fs.existsSync(resourcesPath)) {
    fs.mkdirSync(resourcesPath);
  }

  server.route = function route(req, res) {
    config.loadConfig(serverpath, server, function(err, resourcesInstances) {
      if (err) throw err;
      server.resources = resourcesInstances;
      var router = server.router = new Router(resourcesInstances, server);
      router.route(req, res);
    });
  };

  // lazy-load OR bootstrap load?
  // config.loadConfig(&#x27;./&#x27;, server, function(err, resourcesInstances) {
  //     if (err) {
  //         console.error();
  //         console.error(&#x22;Error loading resources: &#x22;);
  //         console.error(err.stack || err);
  //         process.exit(1);
  //     } else {
  //         server.resources = resourcesInstances;
  //         var router = server.router = new Router(resourcesInstances, server);
  //     }
  // });


  server.on(&#x27;request:error&#x27;, function (err, req, res) {
    console.error();
    console.error(req.method, req.url, err.stack || err);
    process.exit(1);
  });




  /**
  * Create a new `Store` for persisting data using the database info that was passed to the server when it was create ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*   var http = require(&#x27;http&#x27;);
*   var express = require(&#x27;express&#x27;);
*   var app = express();
*   var server = http.createServer(app);
*   var io = require(&#x27;socket.io&#x27;).listen(server, {&#x27;log level&#x27;: 0});
*
*   var deployd = require(&#x27;deployd&#x27;)
*   deployd.<span class="apidocCodeKeywordSpan">attach</span>(server, {socketIo: io, env: ENV, db:{host:&#x27;localhost&#x27;, port
:27015, name:&#x27;my-db&#x27;} } );
*   app.use(server.handleRequest);
*
*   server.listen();
*
* @param {Object} options
* @return {HttpServer}
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.client_js" id="apidoc.element.deployd.client_js">
        function <span class="apidocSignatureSpan">deployd.</span>client_js
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ClientLib(name, options) {
  Resource.apply(this, arguments);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.context" id="apidoc.element.deployd.context">
        function <span class="apidocSignatureSpan">deployd.</span>context
        <span class="apidocSignatureSpan">(resource, req, res, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Context(resource, req, res, server) {
  var ctx = this;
  this.url = req.url.slice(resource.path.length).split(&#x27;?&#x27;)[0];
  if (this.url.indexOf(&#x27;/&#x27;) !== 0) this.url = &#x27;/&#x27; + this.url;

  this.req = req;
  this.res = res;
  this.body = req.body;
  this.query = req.query || {};
  this.server = server;
  this.session = req.session;
  this.method = req &#x26;&#x26; req.method;

  // always bind done to this
  var done = this.done;
  this.done = function() {
    done.apply(ctx, arguments);
  };

  if ((this.query &#x26;&#x26; typeof this.query.$limitRecursion !== &#x27;undefined&#x27;) || (this.body &#x26;&#x26; typeof this.body.$limitRecursion !== &#x27;undefined
&#x27;)) {
    var recursionLimit = this.query.$limitRecursion || this.body.$limitRecursion || 0;
    req.stack = req.stack || [];
    req.stack.recursionLimit = recursionLimit;
  }

  this.dpd = internalClient.build(server, req.session, req.stack, ctx);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard" id="apidoc.element.deployd.dashboard">
        function <span class="apidocSignatureSpan">deployd.</span>dashboard
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Dashboard() {
  // internal resource
  this.internal = true;

  this.loadTypes = async.memoize(this.loadTypes);
  this.loadLayout = async.memoize(this.loadLayout);

  Resource.apply(this, arguments);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
dpd.on(&#x27;error&#x27;, onError);
dpd.listen();

function onListening () {
  console.info(&#x27;listening on port&#x27;, options.port);
  var commands = repl(dpd);
  if (program.dashboard) {
    commands.<span class="apidocCodeKeywordSpan">dashboard</span>();
  } else if (program.open) {
    commands.open();
  }
}

function onError (err) {
  if (err.code === &#x22;EADDRINUSE&#x22;) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.files" id="apidoc.element.deployd.files">
        function <span class="apidocSignatureSpan">deployd.</span>files
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Files(name, options) {
  Resource.apply(this, arguments);
  if(this.config.public) {
    this.public = this.config.public;
  } else {
    throw new Error(&#x27;public root folder location required when creating a file resource&#x27;);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  var re = new RegExp(&#x27;\\.(&#x27; + ext.join(&#x27;|&#x27;) + &#x27;)$&#x27;);

  fs.readdirSync(dir)
  .filter(ignored)
  .forEach(function(path){
    path = join(dir, path);
    if (fs.statSync(path).isDirectory()) {
      exports.<span class="apidocCodeKeywordSpan">files</span>(path, ext, ret);
    } else if (path.match(re)) {
      ret.push(path);
    }
  });

  return ret;
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.internal_resources" id="apidoc.element.deployd.internal_resources">
        function <span class="apidocSignatureSpan">deployd.</span>internal_resources
        <span class="apidocSignatureSpan">(settings, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function InternalResources(settings, server) {
  settings.configPath = settings.configPath || &#x27;./&#x27;;
  Resource.apply(this, arguments);
  this.server = server;
  // internal resource
  this.internal = true;
  debug(&#x27;constructed&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys" id="apidoc.element.deployd.keys">
        function <span class="apidocSignatureSpan">deployd.</span>keys
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Keys(path) {
  this.path = path || &#x27;.dpd/keys.json&#x27;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*
* @param {Object} obj
* @return {Number}
* @api public
*/

exports.length = function(obj){
 return exports.<span class="apidocCodeKeywordSpan">keys</span>(obj).length;
};

/**
* Check if `obj` is empty.
*
* @param {Object} obj
* @return {Boolean}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource" id="apidoc.element.deployd.resource">
        function <span class="apidocSignatureSpan">deployd.</span>resource
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.router" id="apidoc.element.deployd.router">
        function <span class="apidocSignatureSpan">deployd.</span>router
        <span class="apidocSignatureSpan">(resources, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Router(resources, server) {
  this.resources = resources || [];
  this.server = server;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script" id="apidoc.element.deployd.script">
        function <span class="apidocSignatureSpan">deployd.</span>script
        <span class="apidocSignatureSpan">(src, path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Script(src, path) {
  this.scriptSourceCode = src;
  this.path = path;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server" id="apidoc.element.deployd.server">
        function <span class="apidocSignatureSpan">deployd.</span>server
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Server(options) {
  var server = process.server = this;
  http.Server.call(this);

  // defaults
  this.options = options = extend({
    port: 2403,
    db: {port: 27017, host: &#x27;127.0.0.1&#x27;, name: &#x27;deployd&#x27;}
  }, options);

  debug(&#x27;started with options %j&#x27;, options);

  // an object to map a server to its stores
  this.stores = {};

  // back all memory stores with a db
  this.db = db.create(options.db);

  var socketServer = io.listen(this, _.extend({
    &#x27;log level&#x27;: 0
  }, (this.options.socketIo &#x26;&#x26; this.options.socketIo.options) || {}));

  // use socket io for a session based realtime channel
  this.sockets = socketServer.sockets;

  if (this.options.socketIo &#x26;&#x26; this.options.socketIo.adapter) {
    socketServer.adapter(this.options.socketIo.adapter);
  }

  // persist sessions in a store
  this.sessions = new SessionStore(&#x27;sessions&#x27;, this.db, this.sockets, options.sessions);

  // persist keys in a store
  this.keys = new Keys();

  this.on(&#x27;request&#x27;, server.handleRequest);

  server.on(&#x27;request:error&#x27;, function (err, req, res) {
    console.error();
    console.error(req.method, req.url, err.stack || err);
    process.exit(1);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection" id="apidoc.element.deployd.user_collection">
        function <span class="apidocSignatureSpan">deployd.</span>user_collection
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function UserCollection(name, options) {
  Collection.apply(this, arguments);

  if(!this.properties) {
    this.properties = {};
  }

  // username and password are required
  this.properties.username = this.properties.username || {type: &#x27;string&#x27;};
  this.properties.username.required = true;
  this.properties.password = this.properties.password || {type: &#x27;string&#x27;};
  this.properties.password.required = true;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>








































</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.ayepromise" id="apidoc.module.deployd.ayepromise">module deployd.ayepromise</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.ayepromise.defer" id="apidoc.element.deployd.ayepromise.defer">
        function <span class="apidocSignatureSpan">deployd.ayepromise.</span>defer
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">defer = function () {
    var state = PENDING,
        outcome,
        thenHandlers = [];

    var doSettle = function (settledState, value) {
        state = settledState;
        // persist for handlers registered after settling
        outcome = value;

        thenHandlers.forEach(function (then) {
            then.handle(state, outcome);
        });

        // Discard all references to handlers to be garbage collected
        thenHandlers = null;
    };

    var doFulfill = function (value) {
        doSettle(FULFILLED, value);
    };

    var doReject = function (error) {
        doSettle(REJECTED, error);
    };

    var registerThenHandler = function (onFulfilled, onRejected) {
        var thenHandler = aThenHandler(onFulfilled, onRejected);

        if (state === PENDING) {
            thenHandlers.push(thenHandler);
        } else {
            thenHandler.handle(state, outcome);
        }

        return thenHandler.promise;
    };

    var safelyResolveThenable = function (thenable) {
        // Either fulfill, reject or reject with error
        var onceWrapper = once();
        try {
            thenable(
                onceWrapper(transparentlyResolveThenablesAndSettle),
                onceWrapper(doReject)
            );
        } catch (e) {
            onceWrapper(doReject)(e);
        }
    };

    var transparentlyResolveThenablesAndSettle = function (value) {
        var thenable;

        try {
            thenable = getThenableIfExists(value);
        } catch (e) {
            doReject(e);
            return;
        }

        if (thenable) {
            safelyResolveThenable(thenable);
        } else {
            doFulfill(value);
        }
    };

    var onceWrapper = once();
    return {
        resolve: onceWrapper(transparentlyResolveThenablesAndSettle),
        reject: onceWrapper(doReject),
        promise: {
            then: registerThenHandler,
            fail: function (onRejected) {
                return registerThenHandler(null, onRejected);
            }
        }
    };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  return req.responseText;
}

}

function sendRequest(url,options) {
var req = createXMLHTTPObject();
var deferred = ayepromise.<span class="apidocCodeKeywordSpan">defer</span>();
if (!req) return Error(&#x22;AJAX is somehow not supported&#x22;);

if (options.query) url += &#x27;?&#x27; + options.query;

var data = options.data;
var method = options.method || &#x22;GET&#x22;;
req.open(method,url,true);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.client_js" id="apidoc.module.deployd.client_js">module deployd.client_js</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.client_js.client_js" id="apidoc.element.deployd.client_js.client_js">
        function <span class="apidocSignatureSpan">deployd.</span>client_js
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ClientLib(name, options) {
  Resource.apply(this, arguments);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.client_js.super_" id="apidoc.element.deployd.client_js.super_">
        function <span class="apidocSignatureSpan">deployd.client_js.</span>super_
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.client_js.prototype" id="apidoc.module.deployd.client_js.prototype">module deployd.client_js.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.client_js.prototype.generate" id="apidoc.element.deployd.client_js.prototype.generate">
        function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>generate
        <span class="apidocSignatureSpan">(res, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">generate = function (res, fn) {
  var clientLib = this;

  res.write(&#x27;\n\n// automatically generated code\n\n&#x27;);
  this.config.resources.forEach(function(r) {
    clientLib.generateResource(r, res);
  });
  fn();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

/*!
 * Create a new key and save it in the keys file.
 */

Keys.prototype.create = function(fn) {
  var key = this.<span class="apidocCodeKeywordSpan">generate</span>()
, keys = this;

  this.readFile(function(err, data) {
if(err) return fn(err);

data[key] = true;
keys.writeFile(data, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.client_js.prototype.generateResource" id="apidoc.element.deployd.client_js.prototype.generateResource">
        function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>generateResource
        <span class="apidocSignatureSpan">(r, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">generateResource = function (r, res) {
  var jsName = r.path.replace(/[^A-Za-z0-9]/g, &#x27;&#x27;)
    , i;

  if (r.clientGeneration &#x26;&#x26; jsName) {
    res.write(&#x27;dpd.&#x27; + jsName + &#x27; = dpd(&#x22;&#x27; + r.path + &#x27;&#x22;);\n&#x27;);
    if (r.clientGenerationExec) {
      for (i = 0; i &#x3c; r.clientGenerationExec.length; i++) {
        res.write(&#x27;dpd.&#x27; + jsName + &#x27;.&#x27; + r.clientGenerationExec[i] + &#x27; = function(path, body, fn) {\n&#x27;);
        res.write(&#x27;  return dpd.&#x27; + jsName + &#x27;.exec(&#x22;&#x27; + r.clientGenerationExec[i] + &#x27;&#x22;, path, body, fn);\n&#x27;);
        res.write(&#x27;}\n&#x27;);
      }
    }
    if (r.clientGenerationGet) {
      for (i = 0; i &#x3c; r.clientGenerationGet.length; i++) {
        res.write(&#x27;dpd.&#x27; + jsName + &#x27;.&#x27; + r.clientGenerationGet[i] + &#x27; = function(path, query, fn) {\n&#x27;);
        res.write(&#x27;  return dpd.&#x27; + jsName + &#x27;.get(&#x22;&#x27; + r.clientGenerationGet[i] + &#x27;&#x22;, path, query, fn);\n&#x27;);
        res.write(&#x27;}\n&#x27;);
      }
    }
    // resource event namespacing sugar
    res.write(&#x27;dpd.&#x27; + jsName + &#x27;.on = function(ev, fn) {\n&#x27;);
    res.write(&#x27;  return dpd.on(&#x22;&#x27; + r.path.replace(&#x27;/&#x27;, &#x27;&#x27;) + &#x27;&#x22; + &#x22;:&#x22; + ev, fn);\n&#x27;);
    res.write(&#x27;}\n&#x27;);
    res.write(&#x27;dpd.&#x27; + jsName + &#x27;.once = function(ev, fn) {\n&#x27;);
    res.write(&#x27;  return dpd.once(&#x22;&#x27; + r.path.replace(&#x27;/&#x27;, &#x27;&#x27;) + &#x27;&#x22; + &#x22;:&#x22; + ev, fn);\n&#x27;);
    res.write(&#x27;}\n&#x27;);
    res.write(&#x27;dpd.&#x27; + jsName + &#x27;.off = function(ev, fn) {\n&#x27;);
    res.write(&#x27;  return dpd.off(&#x22;&#x27; + r.path.replace(&#x27;/&#x27;, &#x27;&#x27;) + &#x27;&#x22; + &#x22;:&#x22; + ev, fn);\n&#x27;);
    res.write(&#x27;}\n&#x27;);
  }

  if(r.external) {
    Object.keys(r.external).forEach(function (name) {
      res.write(&#x27;dpd.&#x27; + jsName + &#x27;.&#x27; + name + &#x27; = function (path, body, fn) {\n&#x27;);
      res.write(&#x27;  dpd.&#x27; + jsName + &#x27;.exec(&#x22;&#x27; + name + &#x27;&#x22;, path, body, fn);\n&#x27;);
      res.write(&#x27;}\n&#x27;);
    });
  }

  res.write(&#x27;\n&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

ClientLib.prototype.generate = function(res, fn) {
var clientLib = this;

res.write(&#x27;\n\n// automatically generated code\n\n&#x27;);
this.config.resources.forEach(function(r) {
  clientLib.<span class="apidocCodeKeywordSpan">generateResource</span>(r, res);
});
fn();
};

ClientLib.prototype.generateResource = function(r, res) {
var jsName = r.path.replace(/[^A-Za-z0-9]/g, &#x27;&#x27;)
  , i;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.client_js.prototype.handle" id="apidoc.element.deployd.client_js.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx, next) {
  var resource = this;

  if (ctx.url === &#x27;/&#x27;) {
    ctx.res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/javascript&#x27;);
    var lib = resource.clientLib;

    ctx.res.write(lib);
    resource.generate(ctx.res, function() {
      ctx.res.end();
    });
  } else {
    next();
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.client_js.prototype.load" id="apidoc.element.deployd.client_js.prototype.load">
        function <span class="apidocSignatureSpan">deployd.client_js.prototype.</span>load
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">load = function (fn) {
  var resource = this;

  async.parallel({
    dpdJs: function(callback) {
      fs.readFile(path.join(__dirname, &#x27;../../clib/dpd.js&#x27;), &#x27;utf-8&#x27;, callback);
    },
    socketIo: function(callback) {
      fs.readFile(path.join(__dirname, &#x27;../../clib/socket.io.min.js&#x27;), &#x27;utf-8&#x27;, callback);
    },
    promise: function(callback) {
      fs.readFile(path.join(__dirname, &#x27;../../clib/ayepromise.min.js&#x27;), &#x27;utf-8&#x27;, callback);
    },
    ajax: function(callback) {
      fs.readFile(path.join(__dirname, &#x27;../../clib/ajax.js&#x27;), &#x27;utf-8&#x27;, callback);
    }
  }, function(err, results) {
    if (err) return fn(err);
    var file = results.socketIo + &#x22;\n\n&#x22;
             + results.promise + &#x22;\n\n&#x22;
             + results.ajax + &#x22;\n\n&#x22;
             + results.dpdJs;
    resource.clientLib = file;
    fn();
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, fn);
}

function loadResourceExtras(resource, fn) {
async.series([
  function(fn) {
    if (resource.load) {
      resource.<span class="apidocCodeKeywordSpan">load</span>(fn);
    } else {
      fn();
    }
  }
], function(err) {
  fn(err, resource);
});
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.config_loader" id="apidoc.module.deployd.config_loader">module deployd.config_loader</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.config_loader.loadConfig" id="apidoc.element.deployd.config_loader.loadConfig">
        function <span class="apidocSignatureSpan">deployd.config_loader.</span>loadConfig
        <span class="apidocSignatureSpan">(basepath, server, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadConfig = function (basepath, server, fn) {
  var resources = server.__resourceCache || [];

  if (resources.length) {
    debug(&#x22;Loading from cache&#x22;);
    fn(null, resources);
    return;
  }

  var getTypes = async.memoize(loadTypes);

  async.waterfall([
      async.apply(loadResourceDir, basepath)
    , async.apply(loadResources, getTypes, basepath, server)
    , async.apply(addInternalResources, server, basepath)
  ], function(err, result) {
    if (server.options &#x26;&#x26; server.options.env !== &#x27;development&#x27;) {
      server.__resourceCache = result;
    }
    fn(err, result);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var resourcesPath = path.join(serverpath, &#x27;resources&#x27;);
// use sync functions, as only run once when server start-up
if (!fs.existsSync(resourcesPath)) {
  fs.mkdirSync(resourcesPath);
}

server.route = function route(req, res) {
  config.<span class="apidocCodeKeywordSpan">loadConfig</span>(serverpath, server, function(err, resourcesInstances) {
    if (err) throw err;
    server.resources = resourcesInstances;
    var router = server.router = new Router(resourcesInstances, server);
    router.route(req, res);
  });
};
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.context" id="apidoc.module.deployd.context">module deployd.context</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.context.context" id="apidoc.element.deployd.context.context">
        function <span class="apidocSignatureSpan">deployd.</span>context
        <span class="apidocSignatureSpan">(resource, req, res, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Context(resource, req, res, server) {
  var ctx = this;
  this.url = req.url.slice(resource.path.length).split(&#x27;?&#x27;)[0];
  if (this.url.indexOf(&#x27;/&#x27;) !== 0) this.url = &#x27;/&#x27; + this.url;

  this.req = req;
  this.res = res;
  this.body = req.body;
  this.query = req.query || {};
  this.server = server;
  this.session = req.session;
  this.method = req &#x26;&#x26; req.method;

  // always bind done to this
  var done = this.done;
  this.done = function() {
    done.apply(ctx, arguments);
  };

  if ((this.query &#x26;&#x26; typeof this.query.$limitRecursion !== &#x27;undefined&#x27;) || (this.body &#x26;&#x26; typeof this.body.$limitRecursion !== &#x27;undefined
&#x27;)) {
    var recursionLimit = this.query.$limitRecursion || this.body.$limitRecursion || 0;
    req.stack = req.stack || [];
    req.stack.recursionLimit = recursionLimit;
  }

  this.dpd = internalClient.build(server, req.session, req.stack, ctx);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.context.prototype" id="apidoc.module.deployd.context.prototype">module deployd.context.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.context.prototype.done" id="apidoc.element.deployd.context.prototype.done">
        function <span class="apidocSignatureSpan">deployd.context.prototype.</span>done
        <span class="apidocSignatureSpan">(err, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">done = function (err, res) {
  var body = res
    , type = &#x27;application/json&#x27;;

  // default response
  var status = this.res.statusCode = this.res.statusCode || 200;

  if(err) {
    debug(&#x27;%j&#x27;, err);
    if(status &#x3c; 400) this.res.statusCode = 400;
    if(err.statusCode) this.res.statusCode = err.statusCode;
    respond(err, this.req, this.res);
  } else {
    if(typeof body == &#x27;object&#x27;) {
      body = JSON.stringify(body);
    } else {
      type = &#x27;text/html; charset=utf-8&#x27;;
    }

    try {
      this.res.setHeader(&#x22;Cache-Control&#x22;, &#x22;no-cache, no-store, must-revalidate&#x22;);
      this.res.setHeader(&#x22;Pragma&#x22;, &#x22;no-cache&#x22;);
      this.res.setHeader(&#x22;Expires&#x22;, &#x22;0&#x22;);
      if(status != 204 &#x26;&#x26; status != 304) {
        if(body) {
          this.res.setHeader(&#x27;Content-Length&#x27;, Buffer.isBuffer(body)
               ? body.length
               : Buffer.byteLength(body));
        }
        this.res.setHeader(&#x27;Content-Type&#x27;, type);
        this.res.end(body);
      } else {
        this.res.end();
      }
    } catch(e) {
      console.error(e);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
   fn();
 }
};

/**
* Handle an incoming request. This gets called by the router.
* Call `next()` if the resource cannot handle the request.
* Otherwise call `cxt.<span class="apidocCodeKeywordSpan">done</span>(err, res)` when the resource
* is ready to respond.
*
* Example:
*
*  Override the handle method to return a string:
*
*     function MyResource(settings) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.context.prototype.end" id="apidoc.element.deployd.context.prototype.end">
        function <span class="apidocSignatureSpan">deployd.context.prototype.</span>end
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">end = function () {
  return this.res.end.apply(this.res, arguments);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  server.handleRequest = function handleRequest(req, res) {
    // dont handle socket.io requests
    if(req.url.indexOf(&#x27;/socket.io/&#x27;) === 0) return;
    debug(&#x27;%s %s&#x27;, req.method, req.url);

    // add utilites to req and res
    setupReqRes(server.options, req, res, function(err, next) {
if(err) return res.<span class="apidocCodeKeywordSpan">end</span>(err.message);

var authToken, usesBearerAuth = false;
if (req.headers &#x26;&#x26; req.headers.authorization) {
  var parts = req.headers.authorization.split(&#x27; &#x27;);
  var scheme = parts[0]
  , credentials = parts[1];
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.dashboard" id="apidoc.module.deployd.dashboard">module deployd.dashboard</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.dashboard.dashboard" id="apidoc.element.deployd.dashboard.dashboard">
        function <span class="apidocSignatureSpan">deployd.</span>dashboard
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Dashboard() {
  // internal resource
  this.internal = true;

  this.loadTypes = async.memoize(this.loadTypes);
  this.loadLayout = async.memoize(this.loadLayout);

  Resource.apply(this, arguments);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
dpd.on(&#x27;error&#x27;, onError);
dpd.listen();

function onListening () {
  console.info(&#x27;listening on port&#x27;, options.port);
  var commands = repl(dpd);
  if (program.dashboard) {
    commands.<span class="apidocCodeKeywordSpan">dashboard</span>();
  } else if (program.open) {
    commands.open();
  }
}

function onError (err) {
  if (err.code === &#x22;EADDRINUSE&#x22;) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.super_" id="apidoc.element.deployd.dashboard.super_">
        function <span class="apidocSignatureSpan">deployd.dashboard.</span>super_
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.dashboard.prototype" id="apidoc.module.deployd.dashboard.prototype">module deployd.dashboard.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.handle" id="apidoc.element.deployd.dashboard.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx, next) {

  if (ctx.req.url === this.path) {
    return httpUtil.redirect(ctx.res, ctx.req.url + &#x27;/&#x27;);
  } else if (ctx.url === &#x27;/__is-root&#x27;) {
    ctx.done(null, {isRoot: ctx.req.isRoot});
  } else if (ctx.url.indexOf(&#x27;/__custom&#x27;) === 0) {
    this.serveCustomAsset(ctx, next);
  } else if (ctx.url.indexOf(&#x27;.&#x27;) !== -1) {
    filed(path.join(__dirname, &#x27;dashboard&#x27;, ctx.url)).pipe(ctx.res);
  } else if (!ctx.req.isRoot &#x26;&#x26; (!ctx.server.options || ctx.server.options.env !== &#x27;development&#x27;)) {
    filed(path.join(__dirname, &#x27;dashboard&#x27;, &#x27;auth.html&#x27;)).pipe(ctx.res);
  } else {
    this.render(ctx);
  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.loadAdvancedDashboard" id="apidoc.element.deployd.dashboard.prototype.loadAdvancedDashboard">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadAdvancedDashboard
        <span class="apidocSignatureSpan">(data, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadAdvancedDashboard = function (data, fn) {
  var pagePath = data.pagePath
    , dashboardPath = data.dashboardPath
    , page = data.page
    , resourceType = data.resourceType
    , options = data.options;


  async.parallel({
    bodyHtml: function(fn) {
      fs.readFile(pagePath, &#x27;utf-8&#x27;, fn);
    },

    scripts: function(fn) {
      if (resourceType.dashboard.scripts) {
        resourceType.dashboard.scripts.forEach(function(s) {
          options.scripts.push(&#x27;/__custom/&#x27; + resourceType.name.toLowerCase() + s);
        });
      }

      fs.exists(path.join(dashboardPath, &#x27;js&#x27;, page + &#x27;.js&#x27;), function(exists) {
        if (exists) {
          options.scripts.push(&#x27;/__custom/&#x27; + resourceType.name.toLowerCase() + &#x27;/js/&#x27; + page + &#x27;.js&#x27;);
        }

        fn();
      });
    },

    stylesheet: function(fn) {
      fs.exists(path.join(resourceType.dashboard.path, &#x27;style.css&#x27;), function(exists) {
        if (exists) {
          options.css = &#x27;/__custom/&#x27; + resourceType.name.toLowerCase() + &#x27;/style.css&#x27;;
        }

        fn();
      });
    }
  }, function(err, results) {
    if (err) return fn(err);

    options.bodyHtml = results.bodyHtml;

    if (page === &#x27;index&#x27;) page = &#x27;config&#x27;;
    options.page = page;

    fn(null, options);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  } else {
    fn(null, false);
  }
},

function(exists, fn) {
  if (exists) {
    self.<span class="apidocCodeKeywordSpan">loadAdvancedDashboard</span>({
        pagePath: pagePath
      , dashboardPath: dashboardPath
      , page: page
      , resourceType: resourceType
      , options: options
    }, fn);
  } else {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.loadBasicDashboard" id="apidoc.element.deployd.dashboard.prototype.loadBasicDashboard">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadBasicDashboard
        <span class="apidocSignatureSpan">(data, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadBasicDashboard = function (data, fn) {
  var options = data.options
    , page = data.page
    , resourceType = data.resourceType
    , dashboardPath = path.join(__dirname, &#x27;dashboard&#x27;);

  options.page = page;
  if (page === &#x27;index&#x27;) {
    options.page = &#x27;config&#x27;;
    if (resourceType.basicDashboard) {
      options.scripts.push(&#x27;/js/basic.js&#x27;);
      options.basicDashboard = resourceType.basicDashboard;
      fs.readFile(path.join(dashboardPath, &#x27;basic.html&#x27;), function(err, bodyHtml) {
        options.bodyHtml = bodyHtml;
        fn(err);
      });
    } else {
      options.scripts.push(&#x27;/js/default.js&#x27;);
      fs.readFile(path.join(dashboardPath, &#x27;default.html&#x27;), function(err, bodyHtml) {
        options.bodyHtml = bodyHtml;
        fn(err);
      });
    }
  } else if (page === &#x27;events&#x27;) {
    fs.readFile(path.join(dashboardPath, &#x27;events.html&#x27;), function(err, bodyHtml) {
      options.bodyHtml = bodyHtml;
      fn(err);
    });
  } else {
    return fn();
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
          pagePath: pagePath
        , dashboardPath: dashboardPath
        , page: page
        , resourceType: resourceType
        , options: options
      }, fn);
    } else {
      self.<span class="apidocCodeKeywordSpan">loadBasicDashboard</span>({
          options: options
        , page: page
        , resourceType: resourceType
      }, fn);
    }
  }
], function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.loadLayout" id="apidoc.element.deployd.dashboard.prototype.loadLayout">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadLayout
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadLayout = function (fn) {

  fs.readFile(path.join(__dirname, &#x27;dashboard&#x27;, &#x27;index.ejs&#x27;), &#x27;utf-8&#x27;, function(err, layout) {
    if (err) return fn(err);
    var layoutTemplate = ejs.compile(layout, {delimiter:&#x27;?&#x27;}); //Avoid conlicts by using non-standard tags
    fn(null, layoutTemplate);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.loadPage" id="apidoc.element.deployd.dashboard.prototype.loadPage">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadPage
        <span class="apidocSignatureSpan">(ctx, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadPage = function (ctx, fn) {
  var parts = ctx.url.split(&#x27;/&#x27;).filter(function(p) { return p; })
    , resourceId
    , resource
    , resourceType
    , options = {}
    , self = this
    , dashboardPath
    , pagePath;

  if (parts.length) {
    resourceId = parts[0];
    resource = ctx.server.resources.filter(function(r) { return r.name === resourceId.toLowerCase() })[0];

    if (resource) {
      options.resourceId = resourceId;
      resourceType = resource.constructor;
      options.resourceType = resourceType.name;
      options.events = resourceType.events;
      options.scripts = [];

      var page = parts[1];

      if (!page &#x26;&#x26; resourceType.dashboard &#x26;&#x26; resourceType.dashboard.pages) {
        page = resourceType.dashboard.pages[0];
      } else if (!page) {
        page = &#x27;index&#x27;;
      }
      if (page === &#x27;config&#x27;) page = &#x27;index&#x27;;

      dashboardPath = resourceType.dashboard &#x26;&#x26; resourceType.dashboard.path;

      async.waterfall([
        function(fn) {
          if (dashboardPath) {
            pagePath = path.join(dashboardPath, page + &#x27;.html&#x27;);
            fs.exists(pagePath, function(exists) {
              fn(null, exists);
            });
          } else {
            fn(null, false);
          }
        },

        function(exists, fn) {
          if (exists) {
            self.loadAdvancedDashboard({
                pagePath: pagePath
              , dashboardPath: dashboardPath
              , page: page
              , resourceType: resourceType
              , options: options
            }, fn);
          } else {
            self.loadBasicDashboard({
                options: options
              , page: page
              , resourceType: resourceType
            }, fn);
          }
        }
      ], function(err) {
        fn(err, options);
      });

      debug(&#x22;Editing resource %s of type %s&#x22;, resourceId, resourceType.name);

      return;
    }
  }

  fn(); //blank page
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.loadTypes" id="apidoc.element.deployd.dashboard.prototype.loadTypes">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>loadTypes
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loadTypes = function (fn) {
  loadTypes(function(defaults, types) {
    Object.keys(defaults).forEach(function(key) {
      types[key] = defaults[key];
    });
    fn(null, types);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

afterEach(function() {
  if (fs.existsSync(basepath)) {
      sh.rm(&#x27;-rf&#x27;, basepath);
    }
});

describe(&#x27;.<span class="apidocCodeKeywordSpan">loadTypes</span>(basepath, fn)&#x27;, function() {
  var createPackageJson = function(opts) {
    if (fs.existsSync(basepath)) {
      sh.rm(&#x27;-rf&#x27;, basepath);
    }
    sh.mkdir(&#x27;-p&#x27;, basepath);
    sh.cp(&#x27;./lib/resource.js&#x27;, basepath + &#x27;/resource.js&#x27;);
    sh.cp(&#x27;./lib/script.js&#x27;, basepath + &#x27;/script.js&#x27;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.render" id="apidoc.element.deployd.dashboard.prototype.render">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>render
        <span class="apidocSignatureSpan">(ctx)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">render = function (ctx) {
  var self = this
    , appName = path.basename(path.resolve(&#x27;./&#x27;))
    , env = ctx.server &#x26;&#x26; ctx.server.options &#x26;&#x26; ctx.server.options.env;

  async.parallel({
      layout: self.loadLayout
    , options: async.apply(self.loadPage.bind(self), ctx)
  }, function(err, results) {
    if (err) return ctx.done(err);

    var options = results.options || {}
      , layout = results.layout
      , render = {};

    var context = {
        resourceId: options.resourceId
      , resourceType: options.resourceType
      , page: options.page
      , basicDashboard: options.basicDashboard
      , events: options.events
      , appName: appName
      , env: env
    };

    render.bodyHtml = options.bodyHtml;

    try {
      var rendered = layout({context: context, render: render, scripts: options.scripts || [], css: options.css || null});
      ctx.res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/html; charset=UTF-8&#x27;);
      ctx.res.end(rendered);
    } catch (ex) {
      ctx.done(ex.message);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
} else if (ctx.url.indexOf(&#x27;/__custom&#x27;) === 0) {
  this.serveCustomAsset(ctx, next);
} else if (ctx.url.indexOf(&#x27;.&#x27;) !== -1) {
  filed(path.join(__dirname, &#x27;dashboard&#x27;, ctx.url)).pipe(ctx.res);
} else if (!ctx.req.isRoot &#x26;&#x26; (!ctx.server.options || ctx.server.options.env !== &#x27;development&#x27;)) {
  filed(path.join(__dirname, &#x27;dashboard&#x27;, &#x27;auth.html&#x27;)).pipe(ctx.res);
} else {
  this.<span class="apidocCodeKeywordSpan">render</span>(ctx);
}

};


Dashboard.prototype.serveCustomAsset = function(ctx, next) {
var parts = ctx.url.split(&#x27;/&#x27;).filter(function(p) { return p; })
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.dashboard.prototype.serveCustomAsset" id="apidoc.element.deployd.dashboard.prototype.serveCustomAsset">
        function <span class="apidocSignatureSpan">deployd.dashboard.prototype.</span>serveCustomAsset
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">serveCustomAsset = function (ctx, next) {
  var parts = ctx.url.split(&#x27;/&#x27;).filter(function(p) { return p; })
    , resourceTypePath = parts[1]
    , resource = this;

  resource.loadTypes(function(err, types) {
    var resourceTypeId
      , resourceType
      , dashboardPath
      , reqUrl = parts.slice(2).join(&#x27;/&#x27;);

    resourceTypeId = Object.keys(types).filter(function(t) { return t.toLowerCase() === resourceTypePath; })[0];

    if (resourceTypeId) {
      resourceType = types[resourceTypeId];
      dashboardPath = resourceType &#x26;&#x26; resourceType.dashboard &#x26;&#x26; resourceType.dashboard.path;
      if (dashboardPath) {
        return filed(path.join(dashboardPath, reqUrl)).pipe(ctx.res);
      }
    }

    next();
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Dashboard.prototype.handle = function(ctx, next) {

if (ctx.req.url === this.path) {
  return httpUtil.redirect(ctx.res, ctx.req.url + &#x27;/&#x27;);
} else if (ctx.url === &#x27;/__is-root&#x27;) {
  ctx.done(null, {isRoot: ctx.req.isRoot});
} else if (ctx.url.indexOf(&#x27;/__custom&#x27;) === 0) {
  this.<span class="apidocCodeKeywordSpan">serveCustomAsset</span>(ctx, next);
} else if (ctx.url.indexOf(&#x27;.&#x27;) !== -1) {
  filed(path.join(__dirname, &#x27;dashboard&#x27;, ctx.url)).pipe(ctx.res);
} else if (!ctx.req.isRoot &#x26;&#x26; (!ctx.server.options || ctx.server.options.env !== &#x27;development&#x27;)) {
  filed(path.join(__dirname, &#x27;dashboard&#x27;, &#x27;auth.html&#x27;)).pipe(ctx.res);
} else {
  this.render(ctx);
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.db" id="apidoc.module.deployd.db">module deployd.db</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.db.Db" id="apidoc.element.deployd.db.Db">
        function <span class="apidocSignatureSpan">deployd.db.</span>Db
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Db(options) {
  this.options = options;
  this.connectionString = this.options.connectionString;
  this.connectionOptions = this.options.connectionOptions || null;
  if (!this.connectionString &#x26;&#x26; this.options.host) {
    this.connectionString = url.format({
      protocol: &#x22;mongodb&#x22;,
      slashes: true,
      hostname: this.options.host,
      port: this.options.port,
      auth: this.options.credentials ? this.options.credentials.username + &#x22;:&#x22; + this.options.credentials.password : null,
      pathname: this.options.name
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
, db = require(&#x27;../lib/db&#x27;)
, config = require(__dirname + &#x27;/support/db-remote.config.json&#x27;)
, tester = db.create(config)
, store = tester.createStore(&#x27;test-store&#x27;)
, assert = require(&#x27;assert&#x27;)
, mongodb = require(&#x27;mongodb&#x27;);

var mdb = new mongodb.<span class="apidocCodeKeywordSpan">Db</span>(config.name, new mongodb.Server(config.host, config.port));

before(function(done){
mdb.open(function (err) {
  if(err) {
    done(err);
  } else {
    mdb.removeUser(config.credentials.username, function (err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.db.Store" id="apidoc.element.deployd.db.Store">
        function <span class="apidocSignatureSpan">deployd.db.</span>Store
        <span class="apidocSignatureSpan">(namespace, db)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Store(namespace, db) {
  this.namespace = namespace;
  this._db = db;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.db.create" id="apidoc.element.deployd.db.create">
        function <span class="apidocSignatureSpan">deployd.db.</span>create
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create = function (options) {
  var db = new Db(options);
  return db;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
## 0.6.3

 - Removed dependency on jQuery for dpd.js
 - JSON-formatted &#x22;bad credentials&#x22; login error
 - Improved error reporting on CLI when port is in use
 - If in development mode, and no port has been specifically requested, CLI will retry with up to 5 different ports
 - Fixed &#x22;no open connections&#x22; bug on startup
 - Renamed `Db.connect()` to `Db.<span class="apidocCodeKeywordSpan">create</span>()`
 - Db connections are now lazy and only occur once a request is made
 - Added 500 and 404 error pages
 - Added module domain error handling for better module errors
 - Added automatic reloading on error
 - Dropped support for node 0.6

## 0.6.2
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.files" id="apidoc.module.deployd.files">module deployd.files</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.files.files" id="apidoc.element.deployd.files.files">
        function <span class="apidocSignatureSpan">deployd.</span>files
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Files(name, options) {
  Resource.apply(this, arguments);
  if(this.config.public) {
    this.public = this.config.public;
  } else {
    throw new Error(&#x27;public root folder location required when creating a file resource&#x27;);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  var re = new RegExp(&#x27;\\.(&#x27; + ext.join(&#x27;|&#x27;) + &#x27;)$&#x27;);

  fs.readdirSync(dir)
  .filter(ignored)
  .forEach(function(path){
    path = join(dir, path);
    if (fs.statSync(path).isDirectory()) {
      exports.<span class="apidocCodeKeywordSpan">files</span>(path, ext, ret);
    } else if (path.match(re)) {
      ret.push(path);
    }
  });

  return ret;
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.files.super_" id="apidoc.element.deployd.files.super_">
        function <span class="apidocSignatureSpan">deployd.files.</span>super_
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.files.prototype" id="apidoc.module.deployd.files.prototype">module deployd.files.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.files.prototype.handle" id="apidoc.element.deployd.files.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.files.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx, next) {
  if(ctx.req &#x26;&#x26; ctx.req.method !== &#x27;GET&#x27;) return next();

  send(ctx.req, url.parse(ctx.url).pathname, {root: path.resolve(this.public)})
    .on(&#x27;error&#x27;, function (err) {
      ctx.res.statusCode = 404;
      respond(&#x27;Resource Not Found&#x27;, ctx.req, ctx.res);
    })
    .pipe(ctx.res);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.http" id="apidoc.module.deployd.http">module deployd.http</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.http.getBody" id="apidoc.element.deployd.http.getBody">
        function <span class="apidocSignatureSpan">deployd.http.</span>getBody
        <span class="apidocSignatureSpan">(req, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getBody = function (req, callback){
  if(req.rawBody) {
    return callback(req.rawBody);
  }

  var buf = &#x27;&#x27;;

  req.on(&#x27;data&#x27;, function(chunk){ buf += chunk; });

  req.on(&#x27;end&#x27;, function(){
    return callback(buf);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  it(&#x27;should get body from stream&#x27;, function(done){

var obj = JSON.stringify({foo: &#x27;bar&#x27;})
  , req = new Stream();

var res = this.res;

http.<span class="apidocCodeKeywordSpan">getBody</span>(req, function(buffer) {
  console.error(&#x27;STREAM&#x27;, buffer, typeof buffer);
  expect(buffer).to.exist;
  expect(buffer).to.eql(obj);
  done();
});

req.emit(&#x27;data&#x27;, obj);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.http.parseBody" id="apidoc.element.deployd.http.parseBody">
        function <span class="apidocSignatureSpan">deployd.http.</span>parseBody
        <span class="apidocSignatureSpan">(req, res, mime, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">parseBody = function (req, res, mime, callback) {
  exports.getBody(req, function(buf){

    var parser = JSON;

    if (mime === &#x27;application/x-www-form-urlencoded&#x27;) {
      parser = qs;
    }

    try {
      if(buf.length) {
        if(mime === &#x27;application/json&#x27; &#x26;&#x26; &#x27;{&#x27; != buf[0] &#x26;&#x26; &#x27;[&#x27; != buf[0]) {
          res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/plain&#x27;);
          res.statusCode = 400;
          res.end(&#x27;Could not parse invalid JSON&#x27;);
          return;
        }

        req.body = parser.parse(buf);
        var m = req.body._method;
        if ( m ) {
          req.originalMethod = req.method;
          req.method = m.toUpperCase();
          delete req.body._method;
        }
      } else {
        req.body = {};
      }
      callback();
    } catch (ex) {
      res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/plain&#x27;);
      res.statusCode = 400;
      res.end(&#x27;Failed to parse body as &#x27; + mime);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  req.emit(&#x27;data&#x27;, obj);
  req.emit(&#x27;end&#x27;);

});

});

describe(&#x27;.<span class="apidocCodeKeywordSpan">parseBody</span>()&#x27;, function() {
beforeEach(function () {
  this.res = {
    setHeader: function () {

    }
  };
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.http.parseQuery" id="apidoc.element.deployd.http.parseQuery">
        function <span class="apidocSignatureSpan">deployd.http.</span>parseQuery
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">parseQuery = function (url) {
  var q = url.substr(url.indexOf(&#x27;?&#x27;) + 1);

  if(q) q = decodeURIComponent(q);

  if(q[0] === &#x27;{&#x27; &#x26;&#x26; q[q.length - 1] === &#x27;}&#x27;) {
    return JSON.parse(q);
  } else {
    var parsedQuery = qs.parse(parseUrl(url).query);
    if (parsedQuery._jsonquery) {
      return JSON.parse(parsedQuery._jsonquery);
    }

    return parseNumbersInObject(parsedQuery);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		}
	});
});

describe(&#x27;http&#x27;, function() {
	describe(&#x27;.parseQuery&#x27;, function() {
		it(&#x27;should parse a query string&#x27;, function() {
			var q = http.<span class="apidocCodeKeywordSpan">parseQuery</span>(&#x27;/foo/bar?foo=bar&#x27;);
			expect(q).to.eql({foo:&#x27;bar&#x27;});
		});

		it(&#x27;should parse a json query string&#x27;, function() {
			var q = http.parseQuery(&#x27;/foo/bar?{&#x22;foo&#x22;:&#x22;bar&#x22;}&#x27;);
			expect(q).to.eql({foo:&#x27;bar&#x27;});
		});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.http.redirect" id="apidoc.element.deployd.http.redirect">
        function <span class="apidocSignatureSpan">deployd.http.</span>redirect
        <span class="apidocSignatureSpan">(res, url, statusCode)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">redirect = function (res, url, statusCode) {
  res.statusCode = statusCode || 301;
  res.setHeader(&#x22;Location&#x22;, url);
  res.end();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
module.exports = Dashboard;



Dashboard.prototype.handle = function(ctx, next) {

if (ctx.req.url === this.path) {
  return httpUtil.<span class="apidocCodeKeywordSpan">redirect</span>(ctx.res, ctx.req.url + &#x27;/&#x27;);
} else if (ctx.url === &#x27;/__is-root&#x27;) {
  ctx.done(null, {isRoot: ctx.req.isRoot});
} else if (ctx.url.indexOf(&#x27;/__custom&#x27;) === 0) {
  this.serveCustomAsset(ctx, next);
} else if (ctx.url.indexOf(&#x27;.&#x27;) !== -1) {
  filed(path.join(__dirname, &#x27;dashboard&#x27;, ctx.url)).pipe(ctx.res);
} else if (!ctx.req.isRoot &#x26;&#x26; (!ctx.server.options || ctx.server.options.env !== &#x27;development&#x27;)) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.http.setup" id="apidoc.element.deployd.http.setup">
        function <span class="apidocSignatureSpan">deployd.http.</span>setup
        <span class="apidocSignatureSpan">(options, req, res, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setup = function (options, req, res, next) {
  var remoteHost = req.headers.origin
    , corsOpts = {supportsCredentials: true, methods: ALLOWED_METHODS, maxAge: 300};

  if(remoteHost) {
    corsOpts.origins = options.origins;
  } else {
    corsOpts.supportsCredentials = false;
  }
  corsOpts.responseHeaders = corser.simpleResponseHeaders.concat([&#x22;X-Session-Token&#x22;, &#x22;X-Session-Invalidated&#x22;]).concat(options.allowedResponseHeaders
 || []);
  corsOpts.requestHeaders = corser.simpleRequestHeaders.concat([&#x22;X-Requested-With&#x22;, &#x22;Authorization&#x22;]).concat(options.allowedRequestHeaders
 || []);
  if (options.allowCorsRootRequests) {
    corsOpts.requestHeaders.push(&#x22;dpd-ssh-key&#x22;);
  }

  var handler = corser.create(corsOpts);

  handler(req, res, function () {
    req.cookies = res.cookies = new Cookies(req, res);

    if(~req.url.indexOf(&#x27;?&#x27;)) {
      try {
        req.query = parseQuery(req.url);
        var m = req.query._method;
        if ( m ) {
            req.originalMethod = req.method;
            req.method = m.toUpperCase();
            delete req.query._method;
        }
      } catch (ex) {
        res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/plain&#x27;);
        res.statusCode = 400;
        res.end(&#x27;Failed to parse querystring: &#x27; + ex);
        return;
      }
    }

    switch(req.method) {
      case &#x27;OPTIONS&#x27;:
        // End CORS preflight request.
        res.writeHead(204);
        res.end();
      break;
      case &#x27;POST&#x27;:
      case &#x27;PUT&#x27;:
      case &#x27;DELETE&#x27;:
        var mime = req.headers[&#x27;content-type&#x27;] || &#x27;application/json&#x27;;
        mime = mime.split(&#x27;;&#x27;)[0]; //Just in case there&#x27;s multiple mime types, pick the first

        if(autoParse[mime]) {
          autoParse[mime](req, res, mime, next);
        } else if(typeof options.mimeParser === &#x27;function&#x27;) {
          options.mimeParser(req, res, mime, next);
        } else {
          if(req.headers[&#x27;content-length&#x27;]) req.pause();
          next();
        }
      break;
      default:
        next();
      break;
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  &#x3c;script src=&#x22;util.js&#x22;&#x3e;&#x3c;/script&#x3e;
  &#x3c;script src=&#x22;sinon.js&#x22;&#x3e;&#x3c;/script&#x3e;
  &#x3c;script&#x3e;
  if (typeof initMochaPhantomJS === &#x27;function&#x27;) {
    initMochaPhantomJS()
  }
  &#x3c;/script&#x3e;
  &#x3c;script&#x3e;mocha.<span class="apidocCodeKeywordSpan">setup</span>(&#x27;bdd&#x27;)&#x3c;/script&#x3e;
  &#x3c;!-- -- tests -- --&#x3e;
  &#x3c;script src=&#x22;test/util.test.js&#x22;&#x3e;&#x3c;/script&#x3e;
  &#x3c;script src=&#x22;test/misc.test.js&#x22;&#x3e;&#x3c;/script&#x3e;
  &#x3c;script src=&#x22;test/collection.test.js&#x22;&#x3e;&#x3c;/script&#x3e;
  &#x3c;script src=&#x22;test/user-collection.test.js&#x22;&#x3e;&#x3c;/script&#x3e;
  &#x3c;script src=&#x22;test/clientlib.test.js&#x22;&#x3e;&#x3c;/script&#x3e;
&#x3c;/head&#x3e;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.internal_client" id="apidoc.module.deployd.internal_client">module deployd.internal_client</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.internal_client.build" id="apidoc.element.deployd.internal_client.build">
        function <span class="apidocSignatureSpan">deployd.internal_client.</span>build
        <span class="apidocSignatureSpan">(server, session, stack, ctx)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">build = function (server, session, stack, ctx) {
  var baseMethods
    , dpd = {};

  baseMethods = {
    request: function(method, options, fn) {
      var promise = new Promise(function(resolve, reject) {
        var req
          , res
          , urlKey
          , recursions
          , recursionLimit;

        req = {
            url: joinPath(&#x27;/&#x27;, options.path)
          , method: method
          , query: options.query
          , body: options.body
          , session: session
          , isRoot: session &#x26;&#x26; session.isRoot
          , internal: true
          , headers: (ctx &#x26;&#x26; ctx.req) ? (ctx.req.headers || {}) : {}
          , connection: (ctx &#x26;&#x26; ctx.req) ? (ctx.req.connection || {}) : {}
          , on: function() {}
        };

        var callback = function(data, error) {
          // resolve or reject promise
          if (error) {
            reject(error);
          } else {
            resolve(data);
          }
        };

        urlKey = req.method + &#x27; &#x27; + req.url;

        req.stack = stack || [];
        debug(&#x22;Stack: %j&#x22;, stack);

        recursions = req.stack.filter(function(s) { return s === urlKey; }).length;

        recursionLimit = (stack &#x26;&#x26; stack.recursionLimit) || 2;

        if (recursions &#x3c; recursionLimit) {
          req.stack.push(urlKey);
          debug(&#x22;Putting %s on stack&#x22;, urlKey);

          res = {
            setHeader: function() {},
            end: function(data) {
              if (res.statusCode === 200 || res.statusCode === 204) {
                try {
                  callback(JSON.parse(data), null);
                } catch (ex) {
                  callback(data, null);
                }
              } else {
                try {
                  callback(null, JSON.parse(data));
                } catch (ex) {
                  callback(null, data);
                }
              }
            },
            internal: true,
            headers: {},
            on: function() {}
          };

          server.router.route(req, res);
        } else {
          debug(&#x22;Recursive call detected - aborting&#x22;);
          callback(null, &#x22;Recursive call to &#x22; + urlKey + &#x22; detected&#x22;);
        }

      }).bind(this);

      if (typeof fn === &#x27;function&#x27;) {
        // call our old-style callback for backwards compatibility
        promise
          .then(function (data) {
            fn(data);
          }, function (error) {
            fn(null, error);
          });
      }

      return promise;
    }
  };

  baseMethods.get = function(options, fn) {
    return baseMethods.request.call(this, &#x22;GET&#x22;, options, fn);
  };

  baseMethods.post = function(options, fn) {
    return baseMethods.request.call(this, &#x22;POST&#x22;, options, fn);
  };

  baseMethods.put = function(options, fn) {
    return baseMethods.request.call(this, &#x22;PUT&#x22;, options, fn);
  };

  baseMethods.del = function(options, fn) {
    return baseMethods.request.call(this, &#x22;DELETE&#x22;, options, fn);
  };

  if (server.resources) {
    server.resources.forEach(function(r) {
      if (r.clientGeneration) {
        var jsName = r.path.replace(/[^A-Za-z0-9]/g, &#x27;&#x27;);
        dpd[jsName] = createResourceClient(r, baseMethods);
      }
    });
  }

  return dpd;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

if ((this.query &#x26;&#x26; typeof this.query.$limitRecursion !== &#x27;undefined&#x27;) || (this.body &#x26;&#x26; typeof this
.body.$limitRecursion !== &#x27;undefined&#x27;)) {
  var recursionLimit = this.query.$limitRecursion || this.body.$limitRecursion || 0;
  req.stack = req.stack || [];
  req.stack.recursionLimit = recursionLimit;
}

this.dpd = internalClient.<span class="apidocCodeKeywordSpan">build</span>(server, req.session, req.stack, ctx);
}

/**
 * Alias for `ctx.res.end()`
 */
Context.prototype.end = function() {
return this.res.end.apply(this.res, arguments);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.internal_resources" id="apidoc.module.deployd.internal_resources">module deployd.internal_resources</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.internal_resources.internal_resources" id="apidoc.element.deployd.internal_resources.internal_resources">
        function <span class="apidocSignatureSpan">deployd.</span>internal_resources
        <span class="apidocSignatureSpan">(settings, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function InternalResources(settings, server) {
  settings.configPath = settings.configPath || &#x27;./&#x27;;
  Resource.apply(this, arguments);
  this.server = server;
  // internal resource
  this.internal = true;
  debug(&#x27;constructed&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.internal_resources.super_" id="apidoc.element.deployd.internal_resources.super_">
        function <span class="apidocSignatureSpan">deployd.internal_resources.</span>super_
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.internal_resources.prototype" id="apidoc.module.deployd.internal_resources.prototype">module deployd.internal_resources.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.internal_resources.prototype.handle" id="apidoc.element.deployd.internal_resources.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.internal_resources.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx, next) {

  if (!ctx.req.isRoot) {
    ctx.done({statusCode: 401, message: &#x22;Not Allowed&#x22;});
    return;
  }

  var basepath = this.config.configPath;

  // TODO handle file system ENOENT, send all else to ctx.done
  // if(err) return ctx.done(err);

  var resource
    , id = ctx.url &#x26;&#x26; ctx.url.replace(&#x27;/&#x27;, &#x27;&#x27;)
    , file;

  if(ctx.url === &#x27;/types&#x27;) {
    loadTypes(function(defaults, types) {
      Object.keys(types).forEach(function(key) {
        defaults[key] = types[key];
      });
      Object.keys(defaults).forEach(function(key) {
        if(excludedTypes[key]) return;
        var c = defaults[key]
          , pages = c.dashboard &#x26;&#x26; c.dashboard.pages;

        if (!pages &#x26;&#x26; c.events) {
          pages = [&#x27;Config&#x27;, &#x27;Events&#x27;];
        }

        defaults[key] = {
          type: c.name,
          defaultPath: c.defaultPath,
          label: c.label,
          dashboardPages: pages
        };
      });
      ctx.done(null, defaults);
    });
    return;
  }

  if(ctx.req.method != &#x27;GET&#x27; &#x26;&#x26; ctx.server) {
    // clear cache
    delete ctx.server.__resourceCache;
  }

  switch (ctx.req.method) {
    case &#x27;POST&#x27;:
    case &#x27;PUT&#x27;:
      var parts
        , fileName
        , isJson;

      resource = ctx.body;

      parts = (ctx.url || &#x27;&#x27;).split(&#x27;/&#x27;).filter(function(p) { return p; });

      if (!parts || !parts.length) return ctx.done({statusCode: 400, message: &#x22;You must provide a resource&#x22;});

      id = parts[0];
      if (!parts[1] || parts[parts.length - 1].indexOf(&#x27;.&#x27;) === -1) {
        parts.push(&#x27;config.json&#x27;);
      }
      file = path.join(basepath, &#x27;resources&#x27;, parts.join(&#x27;/&#x27;));

      fileName = parts[parts.length - 1].toLowerCase();
      isJson = fileName.lastIndexOf(&#x27;.json&#x27;) === fileName.length - 5;

      fs.stat(path.join(basepath, &#x27;resources&#x27;, id), function(err, stat) {
        if (!stat || !stat.isDirectory()) {
          fs.mkdir(path.join(basepath, &#x27;resources&#x27;, id), function(err) {
            if (err) return ctx.done(err);
            save();
          });
        } else {
          save();
        }
      });

      function save() {
        if (isJson &#x26;&#x26; !resource.$setAll) {
          fs.readFile(file, &#x27;utf-8&#x27;, function(err, currentValue) {
            if (!currentValue) {
              writeFile(resource);
            } else {
              try {
                var currentJson = JSON.parse(currentValue);
                Object.keys(resource).forEach(function(k) {
                  currentJson[k] = resource[k];
                });
                writeFile(currentJson);
              } catch (ex) {
                writeFile(resource);
              }
            }
          });
        } else if (isJson) {
          delete resource.$setAll;
          writeFile(resource);
        } else {
          writeFile(resource.value);
        }
      }

      function writeFile(value) {
        var newId = value.id;
        delete value.id;
        if (typeof value === &#x27;object&#x27;) value = JSON.stringify(value, null, &#x27;\t&#x27;);
        notifyType(id, &#x27;Changed&#x27;, resource, ctx.server, function(eventError) {
          if(eventError) return ctx.done(eventError);

          fs.writeFile(file, value, function(err) {
            if (err) return ctx.done(err);

            if (fileName.lastIndexOf(&#x27;config.json&#x27;) === fileName.length - (&#x27;config.json&#x27;).length &#x26;&#x26;
                newId &#x26;&#x26; newId !== id) {
              //rename
              if (newId.indexOf(&#x27;/&#x27;) === 0) newId = newId.substring(1);
              fs.rename(path.join(basepath, &#x27;resources&#x27;, id), path.join(basepath, &#x27;resources&#x27;, newId), function(err) {
                if (err) return ctx.done(err);
                resource.id = newId;
                ctx.done(null, resource);
              });
            } else {
              resource.id = id;
              ctx.done(null, resource);
            }
          });
        });
      }

      break;
    case &#x27;GET&#x27;:
      if(id) {
        isJson = undefined;
        file = id;
        if (id.lastIndexOf(&#x27;.&#x27;) &#x3c;= id.lastIndexOf(&#x27;/&#x27;)) {
          file += &#x27;/config.json&#x27;;
        }
        isJson = file.lastIndex ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.keys" id="apidoc.module.deployd.keys">module deployd.keys</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.keys.keys" id="apidoc.element.deployd.keys.keys">
        function <span class="apidocSignatureSpan">deployd.</span>keys
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Keys(path) {
  this.path = path || &#x27;.dpd/keys.json&#x27;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*
* @param {Object} obj
* @return {Number}
* @api public
*/

exports.length = function(obj){
 return exports.<span class="apidocCodeKeywordSpan">keys</span>(obj).length;
};

/**
* Check if `obj` is empty.
*
* @param {Object} obj
* @return {Boolean}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.keys.prototype" id="apidoc.module.deployd.keys.prototype">module deployd.keys.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.create" id="apidoc.element.deployd.keys.prototype.create">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>create
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create = function (fn) {
  var key = this.generate()
    , keys = this;

  this.readFile(function(err, data) {
    if(err) return fn(err);

    data[key] = true;
    keys.writeFile(data, function(err) {
      fn(err, key);
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
## 0.6.3

 - Removed dependency on jQuery for dpd.js
 - JSON-formatted &#x22;bad credentials&#x22; login error
 - Improved error reporting on CLI when port is in use
 - If in development mode, and no port has been specifically requested, CLI will retry with up to 5 different ports
 - Fixed &#x22;no open connections&#x22; bug on startup
 - Renamed `Db.connect()` to `Db.<span class="apidocCodeKeywordSpan">create</span>()`
 - Db connections are now lazy and only occur once a request is made
 - Added 500 and 404 error pages
 - Added module domain error handling for better module errors
 - Added automatic reloading on error
 - Dropped support for node 0.6

## 0.6.2
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.generate" id="apidoc.element.deployd.keys.prototype.generate">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>generate
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">generate = function () {
  return crypto.randomBytes(256).toString(&#x27;hex&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

/*!
 * Create a new key and save it in the keys file.
 */

Keys.prototype.create = function(fn) {
  var key = this.<span class="apidocCodeKeywordSpan">generate</span>()
, keys = this;

  this.readFile(function(err, data) {
if(err) return fn(err);

data[key] = true;
keys.writeFile(data, function(err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.get" id="apidoc.element.deployd.keys.prototype.get">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>get
        <span class="apidocSignatureSpan">(key, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (key, fn) {
  this.readFile(function(err, data) {
    fn(err, data[key]);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  window.dpd = function(resource) {

    var r = {
get: function(func, path, query, fn) {
  var settings = parseGetSignature(arguments);
  settings.path = joinPath(resource, settings.path);

  return baseMethods.<span class="apidocCodeKeywordSpan">get</span>(settings, settings.fn);
}
, post: function(path, query, body, fn) {
  var settings = parsePostSignature(arguments);
  settings.path = joinPath(resource, settings.path);

  return baseMethods.post(settings, settings.fn);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.getLocal" id="apidoc.element.deployd.keys.prototype.getLocal">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>getLocal
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getLocal = function (fn) {
  this.readFile(function(err, data) {
    if(err) return fn(err);
    if(data &#x26;&#x26; typeof data == &#x27;object&#x27;) {
      fn(null, Object.keys(data)[0]);
    } else {
      fn();
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
program
  .command(&#x27;showkey&#x27;)
  .description(&#x27;\tshows current key for connecting to remote dashboard (./.dpd/keys.json)&#x27;)
  .action(function() {
var Keys = require(&#x27;../lib/keys&#x27;)
  , keys = new Keys();

keys.<span class="apidocCodeKeywordSpan">getLocal</span>(function(err, key) {
  if(err) return console.error(err);
  if(!key) {
    console.log(&#x27;No key file found. Run the following to create one:&#x27;);
    console.log();
    console.log(&#x27;dpd keygen&#x27;);
    console.log();
    return;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.readFile" id="apidoc.element.deployd.keys.prototype.readFile">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>readFile
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">readFile = function (fn) {
  fs.readFile(this.path, &#x27;utf-8&#x27;, function(err, data) {
    var jsonData
      , error;

    try {
      jsonData = (data &#x26;&#x26; JSON.parse(data)) || {};
    } catch (ex) {
      error = ex;
    }

    fn(error, jsonData);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    async.auto({
types: function(fn) {
  getTypes(fn);
},

configJsonFile: function(fn) {
  debug(&#x22;reading %s&#x22;, configPath);
  fs.<span class="apidocCodeKeywordSpan">readFile</span>(configPath, &#x27;utf-8&#x27;, fn);
},

configJson: [&#x27;configJsonFile&#x27;, function(results, fn) {
  try {
    var settings = JSON.parse(results.configJsonFile);
    fn(null, settings);
  } catch (ex) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.keys.prototype.writeFile" id="apidoc.element.deployd.keys.prototype.writeFile">
        function <span class="apidocSignatureSpan">deployd.keys.prototype.</span>writeFile
        <span class="apidocSignatureSpan">(data, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">writeFile = function (data, fn) {
  var str;

  try {
    str = JSON.stringify(data);
  } catch(e) {
    return fn(e);
  }

  fs.writeFile(this.path, str, fn);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      var json;
      try {
        json = JSON.parse(body);
      } catch (ex) {}

      if (json &#x26;&#x26; json[&#x27;dist-tags&#x27;] &#x26;&#x26; json[&#x27;dist-tags&#x27;].latest) {
        var latest = json[&#x27;dist-tags&#x27;].latest;
        fs.<span class="apidocCodeKeywordSpan">writeFile</span>(latestversionFile, latest, function(err){
          // Need this callback function to prevent the process being killed, when latestversionFile is NOT writable
        });
      }
    }
  });
}
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.mongod" id="apidoc.module.deployd.mongod">module deployd.mongod</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.mongod.restart" id="apidoc.element.deployd.mongod.restart">
        function <span class="apidocSignatureSpan">deployd.mongod.</span>restart
        <span class="apidocSignatureSpan">(mongod, env, port, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">restart = function (mongod, env, port, fn) {
  var pid;

  debug(&#x27;starting %s&#x27;, mongod);

  try {
    fs.unlinkSync(&#x27;./data/mongod.lock&#x27;);
    pid = JSON.parse(fs.readFileSync(&#x27;./.dpd/pids/mongod&#x27;));

    if(pid) {
      debug(&#x27;pid %s&#x27;, pid);
      process.kill(pid);
    } else {
      debug(&#x27;no pid found&#x27;);
    }
  } catch(e) {}

<span class="apidocCodeCommentSpan">  /*!
  * The mongodb config file is set to the platform-specific null device in order to override the default options of mongodb in
  * Homebrew and similar distributions.
  */
</span>  var options =  [&#x27;--dbpath&#x27;, &#x27;./data&#x27;, &#x27;--pidfilepath&#x27;, &#x27;./.dpd/pids/mongod&#x27;, &#x27;--port&#x27;, port, &#x27;-f&#x27;, fs.existsSync(&#x27;/dev/null&#x27;) ? &#x27;/
dev/null&#x27; : &#x27;NUL&#x27; ];
  if(env === &#x27;development&#x27;) {
    options.push(&#x27;--nojournal&#x27;);
    options.push(&#x27;--smallfiles&#x27;);
    options.push(&#x27;--nssize&#x27;);
    options.push(&#x27;4&#x27;);
  }

  var proc = spawn(mongod, options, {title: &#x27;FOOBAR&#x27;, stdio: &#x27;pipe&#x27;})
    , buf = &#x27;&#x27;;
  proc.stdout.on(&#x27;data&#x27;, function(data) {
    buf += data;
    if(~buf.indexOf(&#x27;waiting for connections on port&#x27;)) {
      proc.emit(&#x27;listening&#x27;);
    }
    debug(data);
  });

  function kill(e) {
    console.log(&#x27;bye&#x27;);
    if(e) debug(&#x27;error: %s&#x27;, e);
    debug(&#x27;killing mongod&#x27;);
    fs.writeFileSync(&#x27;./.dpd/pids/mongod&#x27;, &#x27;&#x27;);
    proc.kill();
    process.exit(0);
  }

  // callback
  proc.once(&#x27;listening&#x27;, fn);
  proc.on(&#x27;error&#x27;, function(err) {
    debug(&#x27;proc error %s %s&#x27;, mongod, err);
    // report error to startup function in bin/dpd
    fn(err);
  });
  proc.on(&#x27;exit&#x27;, function(code) {
    debug(&#x27;exit code %s&#x27;, code);
    if (code) fn(code);
  });

  process.stdin.on(&#x27;end&#x27;, kill);

  process.on(&#x27;exit&#x27;, kill);
  // on non win32 platforms SIGTERM is emitted instead of exit when
  // a process is killed by another process, so use it to end our mongo
  // process
  process.on(&#x27;SIGTERM&#x27;, kill);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
              },
              startup
          );
      } else {
          startup();
      }
  } else {
      mongod.<span class="apidocCodeKeywordSpan">restart</span>(program.mongod || &#x27;mongod&#x27;, env, mongoPort, startup);
  }

} else {
  console.log(&#x22;This directory does not contain a Deployd app!&#x22;);
  console.log(&#x22;Use \&#x22;dpd create &#x3c;appname&#x3e;\&#x22; to create a new app&#x22;);
  console.log(&#x22;or use \&#x22;dpd path/to/app.dpd\&#x22; to start an app in another directory&#x22;);
  stop(1);
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.resource" id="apidoc.module.deployd.resource">module deployd.resource</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.resource.resource" id="apidoc.element.deployd.resource.resource">
        function <span class="apidocSignatureSpan">deployd.</span>resource
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Resource(name, options) {
  EventEmitter.call(this);
  this.name = name;
  this.path = &#x27;/&#x27; + name;
  options = this.options = options || {};
  this.config = options.config || {};
  this.events = {};
  var instance = this;
  if(this.constructor.external) {
    instance.external = {};
    Object.keys(this.constructor.external).forEach(function (key) {
      if(typeof instance.constructor.external[key] == &#x27;function&#x27;) {
        instance.external[key] = function () {
          instance.constructor.external[key].apply(instance, arguments);
        };
      }
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.super_" id="apidoc.element.deployd.resource.super_">
        function <span class="apidocSignatureSpan">deployd.resource.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.toJSON" id="apidoc.element.deployd.resource.toJSON">
        function <span class="apidocSignatureSpan">deployd.resource.</span>toJSON
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function () {
  return {
    type: this.name,
    defaultPath: &#x27;/my-resource&#x27;
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
for (var i = 0; i &#x3c; obj.length; i++) {
    if (_hasBinary(obj[i])) {
        return true;
    }
}
    } else if (obj &#x26;&#x26; &#x27;object&#x27; == typeof obj) {
if (obj.toJSON) {
  obj = obj.<span class="apidocCodeKeywordSpan">toJSON</span>();
}

for (var key in obj) {
  if (obj.hasOwnProperty(key) &#x26;&#x26; _hasBinary(obj[key])) {
    return true;
  }
}
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.resource.prototype" id="apidoc.module.deployd.resource.prototype">module deployd.resource.prototype</a></h1>






    <h2>
        <a href="#apidoc.element.deployd.resource.prototype.handle" id="apidoc.element.deployd.resource.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx, next) {
  ctx.end();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.prototype.load" id="apidoc.element.deployd.resource.prototype.load">
        function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>load
        <span class="apidocSignatureSpan">(fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">load = function (fn) {
  var eventNames = this.constructor &#x26;&#x26; this.constructor.events
    , remaining = eventNames &#x26;&#x26; eventNames.length
    , configPath = this.options &#x26;&#x26; this.options.configPath
    , events = this.events = {};

  if(remaining) {
    eventNames.forEach(function(e) {
      var fileName = e.toLowerCase() + &#x27;.js&#x27;
        , filePath = path.join(configPath, fileName);

      Script.load(filePath, function (err, script) {
        if (script) {
          events[e] = script;
        }
        remaining--;
        if (remaining &#x3c;= 0) {
          fn();
        }
      });
    });
  } else {
    fn();
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, fn);
}

function loadResourceExtras(resource, fn) {
async.series([
  function(fn) {
    if (resource.load) {
      resource.<span class="apidocCodeKeywordSpan">load</span>(fn);
    } else {
      fn();
    }
  }
], function(err) {
  fn(err, resource);
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.resource.prototype.parse" id="apidoc.element.deployd.resource.prototype.parse">
        function <span class="apidocSignatureSpan">deployd.resource.prototype.</span>parse
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">parse = function (url) {
  var parsed = parse(url, true)
    , pathname = parsed.pathname
    , parts = parsed.parts = pathname.split(&#x27;/&#x27;);

  // remove empty
  parts.shift();
  parsed.basepath = parts[0];

  // remove empty trailing slash part
  if(parts[parts.length - 1] === &#x27;&#x27;) parts.pop();

  // the last part is always the identifier
  if(parts.length &#x3e; 1) parsed.id = parts[parts.length - 1];

  if(parsed.query.q &#x26;&#x26; parsed.query.q[0] === &#x27;{&#x27; &#x26;&#x26; parsed.query.q[parsed.query.q.length - 1] === &#x27;}&#x27;) {
    parsed.query.q = JSON.parse(parsed.query.q);
  }

  return parsed;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 }
}

/**
* Parse the arguments
*/

program.<span class="apidocCodeKeywordSpan">parse</span>(process.argv);

if(program.args.length === 0) start();

/**
* Port generation
*/
...</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.router" id="apidoc.module.deployd.router">module deployd.router</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.router.router" id="apidoc.element.deployd.router.router">
        function <span class="apidocSignatureSpan">deployd.</span>router
        <span class="apidocSignatureSpan">(resources, server)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Router(resources, server) {
  this.resources = resources || [];
  this.server = server;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.router.prototype" id="apidoc.module.deployd.router.prototype">module deployd.router.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.router.prototype.generateRegex" id="apidoc.element.deployd.router.prototype.generateRegex">
        function <span class="apidocSignatureSpan">deployd.router.prototype.</span>generateRegex
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">generateRegex = function (path) {
  if (!path || path === &#x27;/&#x27;) path = &#x27;&#x27;;
  path = path.replace(escapeRegExp, &#x27;\\$&#x26;&#x27;);
  return new RegExp(&#x27;^&#x27; + path + &#x27;(?:[/?].*)?$&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    , result;

  debug(&#x27;resources %j&#x27;, this.resources.map(function(r) { return r.path; }));

  if (!this.resources || !this.resources.length) return [];

  result = this.resources.filter(function(d) {
    return url.match(router.<span class="apidocCodeKeywordSpan">generateRegex</span>(d.path));
  }).sort(function(a, b) {
    return specificness(b) - specificness(a);
  });
  return result;
};

/**
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.router.prototype.matchResources" id="apidoc.element.deployd.router.prototype.matchResources">
        function <span class="apidocSignatureSpan">deployd.router.prototype.</span>matchResources
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">matchResources = function (url) {
  var router = this
    , result;

  debug(&#x27;resources %j&#x27;, this.resources.map(function(r) { return r.path; }));

  if (!this.resources || !this.resources.length) return [];

  result = this.resources.filter(function(d) {
    return url.match(router.generateRegex(d.path));
  }).sort(function(a, b) {
    return specificness(b) - specificness(a);
  });
  return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * @api public
 */

Router.prototype.route = function (req, res) {
var router = this
  , server = this.server
  , url = req.url
  , resources = this.<span class="apidocCodeKeywordSpan">matchResources</span>(url)
  , i = 0;

if (req._routed) {
  return;
}

req._routed = true;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.router.prototype.route" id="apidoc.element.deployd.router.prototype.route">
        function <span class="apidocSignatureSpan">deployd.router.prototype.</span>route
        <span class="apidocSignatureSpan">(req, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">route = function (req, res) {
  var router = this
    , server = this.server
    , url = req.url
    , resources = this.matchResources(url)
    , i = 0;

  if (req._routed) {
    return;
  }

  req._routed = true;

  async.series([function(fn) {
    async.forEach(router.resources, function(resource, fn) {
      if(resource.handleSession) {
        var ctx = new Context(resource, req, res, server);
        resource.handleSession(ctx, fn);
      } else {
        fn();
      }
    }, fn);
  }], function(err) {
    if (err) throw err;
    nextResource();
  });

  //TODO: Handle edge case where ctx.next() is called more than once
  function nextResource() {
    var resource = resources[i++]
      , ctx;

    var handler = doh.createHandler({req: req, res: res, server: server});
    handler.run(function () {
      process.nextTick(function () {
        if (resource) {
          debug(&#x27;routing %s to %s&#x27;, req.url, resource.path);
          ctx = new Context(resource, req, res, server);
          ctx.router = router;

          // default root to false
          if(ctx.session) ctx.session.isRoot = req.isRoot || false;

          // external functions
          var furl = ctx.url.replace(&#x27;/&#x27;, &#x27;&#x27;);
          if(resource.external &#x26;&#x26; resource.external[furl]) {
            resource.external[furl](ctx.body, ctx, ctx.done);
          } else {
            resource.handle(ctx, nextResource);
          }
        } else {
          debug(&#x27;404 %s&#x27;, req.url);
          res.statusCode = 404;
          error404({message: &#x27;resource not found&#x27;}, req, res);
        }
      });
    });
  }

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

if (server.options.env === &#x27;development&#x27;) {
  if (root) {
    req.isRoot = true;
  }
  server.<span class="apidocCodeKeywordSpan">route</span>(req, res);
} else if (root) {
  // all root requests
  // must be authenticated
  debug(&#x27;authenticating&#x27;, root);
  server.keys.get(root, function(err, key) {
    if(err) throw err;
    if(key) req.isRoot = true;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.script" id="apidoc.module.deployd.script">module deployd.script</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.script.script" id="apidoc.element.deployd.script.script">
        function <span class="apidocSignatureSpan">deployd.</span>script
        <span class="apidocSignatureSpan">(src, path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Script(src, path) {
  this.scriptSourceCode = src;
  this.path = path;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script.load" id="apidoc.element.deployd.script.load">
        function <span class="apidocSignatureSpan">deployd.script.</span>load
        <span class="apidocSignatureSpan">(path, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">load = function (path, fn) {
  fs.readFile(path, &#x27;utf-8&#x27;, function(err, val) {
    if (val) {
      fn(err, new Script(val, path));
    } else {
      fn(err);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, fn);
}

function loadResourceExtras(resource, fn) {
async.series([
  function(fn) {
    if (resource.load) {
      resource.<span class="apidocCodeKeywordSpan">load</span>(fn);
    } else {
      fn();
    }
  }
], function(err) {
  fn(err, resource);
});
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.script.prototype" id="apidoc.module.deployd.script.prototype">module deployd.script.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.script.prototype.getFunction" id="apidoc.element.deployd.script.prototype.getFunction">
        function <span class="apidocSignatureSpan">deployd.script.prototype.</span>getFunction
        <span class="apidocSignatureSpan">(key)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getFunction = function (key) {
  var cache = memoize.cache;
  var address = &#x27;&#x27; + (hasher ? hasher.apply(this, arguments) : key);
  if (!_.has(cache, address)) cache[address] = func.apply(this, arguments);
  return cache[address];
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Script.prototype.runWithContext = function (context) {
var functionArgs = Object.keys(context);

// remove the argument &#x27;this&#x27; from our list of passed arguments, because it is a reserved word
functionArgs.splice(functionArgs.indexOf(&#x27;this&#x27;), 1);

functionArgs.push(this.scriptSourceCode);
var func = this.<span class="apidocCodeKeywordSpan">getFunction</span>(functionArgs);

// pass our arguments from the sandbox to the function
var args = [];
functionArgs.forEach(function (p) {
  args.push(context[p]);
});
return func.apply(context._this || {}, args);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script.prototype.run" id="apidoc.element.deployd.script.prototype.run">
        function <span class="apidocSignatureSpan">deployd.script.prototype.</span>run
        <span class="apidocSignatureSpan">(ctx, domain, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">run = function (ctx, domain, fn) {

  if (this.error) { fn(this.error); }

  if(typeof domain === &#x27;function&#x27;) {
    fn = domain;
    domain = undefined;
  }

  var req = ctx.req
    , session = ctx.session
    , waitingForCallback = false
    , callbackCount = 0
    , isDone = false
    , events;

  var scriptContext = {
    &#x27;this&#x27;: {},
    cancel: function(msg, status) {
      var err;
      if (util.isError(msg)) {
        err = msg;
      } else if (!status &#x26;&#x26; msg &#x26;&#x26; msg.message &#x26;&#x26; (msg.status || msg.statusCode)) {
        // allow chaining this from another response
        err = {message: msg.message, statusCode: msg.status || msg.statusCode};
      } else {
        err = {message: msg, statusCode: status};
      }
      done(err);
      throw err;
    },
    cancelIf: function(condition, msg, status) {
      if (condition) {
        scriptContext.cancel(msg, status);
      }
    },
    cancelUnless: function(condition, msg, status) {
      scriptContext.cancelIf(!condition, msg, status);
    },
    me: session &#x26;&#x26; session.user,
    isMe: function(id) {
      return (scriptContext.me &#x26;&#x26; scriptContext.me.id === id) || false;
    },
    console: console,
    query: ctx.query,
    internal: req &#x26;&#x26; req.internal,
    isRoot: req &#x26;&#x26; req.session &#x26;&#x26; req.session.isRoot,
    emit: function(collection, query, event, data) {
      if(arguments.length === 4) {
        session.emitToUsers(collection, query, event, data);
      } else if(arguments.length === 3) {
        // collection is room name
        if(session.emitToRoom) session.emitToRoom(collection, query, event);
      } else if(arguments.length &#x3c;= 2) {
        event = collection;
        data = query;
        if(session.emitToAll) session.emitToAll(event, data);
      }
    },
    session: session,
    ctx: ctx
  };

  scriptContext._this = scriptContext[&#x27;this&#x27;];
  scriptContext._error = undefined;

  events = new EventEmitter();

  function done(err) {
    if (isDone) return;
    isDone = true;
    events.removeAllListeners(&#x27;finishCallback&#x27;);
    if (fn) fn(err);
  }

  if(domain) {

    events.on(&#x27;addCallback&#x27;, function() {
      waitingForCallback = true;
      callbackCount++;
    });

    events.on(&#x27;finishCallback&#x27;, function() {
      callbackCount--;
      if (callbackCount &#x3c;= 0) {
        done(scriptContext._error);
      }
    });

    events.on(&#x27;error&#x27;, function (err) {
      done(err);
    });

    domain.$addCallback = function() {
      events.emit(&#x27;addCallback&#x27;);
    };

    domain.$finishCallback = function() {
      events.emit(&#x27;finishCallback&#x27;);
    };
    domain.dpd = ctx.dpd;

    if(fn) {
      // if a callback is expected, count callbacks
      // and manually merge the domain
      wrapAsyncFunctions(domain, scriptContext, events, done);
    } else {
      // otherwise just merge the domain
      Object.keys(domain).forEach(function (key) {
        scriptContext[key] = domain[key];
      });
    }
    scriptContext[&#x27;this&#x27;] = scriptContext._this = domain.data;
  }

  var err;

  try {
    this.runWithContext(scriptContext);
  } catch(e) {
    err = wrapError(e);
    scriptContext._error = err;
  }
  err = err || scriptContext._error;
  process.nextTick(function () {
    if (!waitingForCallback &#x26;&#x26; callbackCount &#x3c;= 0) {
      done(err);
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  //TODO: Handle edge case where ctx.next() is called more than once
  function nextResource() {
    var resource = resources[i++]
      , ctx;

    var handler = doh.createHandler({req: req, res: res, server: server});
    handler.<span class="apidocCodeKeywordSpan">run</span>(function () {
      process.nextTick(function () {
        if (resource) {
debug(&#x27;routing %s to %s&#x27;, req.url, resource.path);
ctx = new Context(resource, req, res, server);
ctx.router = router;

// default root to false
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.script.prototype.runWithContext" id="apidoc.element.deployd.script.prototype.runWithContext">
        function <span class="apidocSignatureSpan">deployd.script.prototype.</span>runWithContext
        <span class="apidocSignatureSpan">(context)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">runWithContext = function (context) {
  var functionArgs = Object.keys(context);

  // remove the argument &#x27;this&#x27; from our list of passed arguments, because it is a reserved word
  functionArgs.splice(functionArgs.indexOf(&#x27;this&#x27;), 1);

  functionArgs.push(this.scriptSourceCode);
  var func = this.getFunction(functionArgs);

  // pass our arguments from the sandbox to the function
  var args = [];
  functionArgs.forEach(function (p) {
    args.push(context[p]);
  });
  return func.apply(context._this || {}, args);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
  scriptContext[&#x27;this&#x27;] = scriptContext._this = domain.data;
}

var err;

try {
  this.<span class="apidocCodeKeywordSpan">runWithContext</span>(scriptContext);
} catch(e) {
  err = wrapError(e);
  scriptContext._error = err;
}
err = err || scriptContext._error;
process.nextTick(function () {
  if (!waitingForCallback &#x26;&#x26; callbackCount &#x3c;= 0) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.server" id="apidoc.module.deployd.server">module deployd.server</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.server.server" id="apidoc.element.deployd.server.server">
        function <span class="apidocSignatureSpan">deployd.</span>server
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Server(options) {
  var server = process.server = this;
  http.Server.call(this);

  // defaults
  this.options = options = extend({
    port: 2403,
    db: {port: 27017, host: &#x27;127.0.0.1&#x27;, name: &#x27;deployd&#x27;}
  }, options);

  debug(&#x27;started with options %j&#x27;, options);

  // an object to map a server to its stores
  this.stores = {};

  // back all memory stores with a db
  this.db = db.create(options.db);

  var socketServer = io.listen(this, _.extend({
    &#x27;log level&#x27;: 0
  }, (this.options.socketIo &#x26;&#x26; this.options.socketIo.options) || {}));

  // use socket io for a session based realtime channel
  this.sockets = socketServer.sockets;

  if (this.options.socketIo &#x26;&#x26; this.options.socketIo.adapter) {
    socketServer.adapter(this.options.socketIo.adapter);
  }

  // persist sessions in a store
  this.sessions = new SessionStore(&#x27;sessions&#x27;, this.db, this.sockets, options.sessions);

  // persist keys in a store
  this.keys = new Keys();

  this.on(&#x27;request&#x27;, server.handleRequest);

  server.on(&#x27;request:error&#x27;, function (err, req, res) {
    console.error();
    console.error(req.method, req.url, err.stack || err);
    process.exit(1);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.super_" id="apidoc.element.deployd.server.super_">
        function <span class="apidocSignatureSpan">deployd.server.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">super_ = function () {
    return;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.server.prototype" id="apidoc.module.deployd.server.prototype">module deployd.server.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.server.prototype.createStore" id="apidoc.element.deployd.server.prototype.createStore">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>createStore
        <span class="apidocSignatureSpan">(namespace)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createStore = function (namespace) {
	return (this.stores[namespace] = this.db.createStore(namespace));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

/**
* Create a new `Store` for persisting data using the database info that was passed to the server when it was created.
*
* Example:
*
*     // Attach a store to the server
*     var todos = server.<span class="apidocCodeKeywordSpan">createStore</span>(&#x27;todos&#x27;);
*
*     // Use the store to CRUD data
*     todos.insert({name: &#x27;go to the store&#x27;, done: true}, ...); // see `Store` for more info
*
* @param {String} namespace
* @return {Store}
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.prototype.handleRequest" id="apidoc.element.deployd.server.prototype.handleRequest">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>handleRequest
        <span class="apidocSignatureSpan">(req, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function handleRequest(req, res) {
  var server = this;
  // dont handle socket.io requests
  if(req.url.indexOf(&#x27;/socket.io/&#x27;) === 0) return;

  debug(&#x27;%s %s&#x27;, req.method, req.url);

  // add utilites to req and res
  setupReqRes(server.options, req, res, function(err, next) {
    if(err) return res.end(err.message);

    var authToken, usesBearerAuth = false;
    if (req.headers &#x26;&#x26; req.headers.authorization) {
      var parts = req.headers.authorization.split(&#x27; &#x27;);
      var scheme = parts[0]
      , credentials = parts[1];

      if (/^Bearer$/i.test(scheme)) {
        authToken = credentials;
        usesBearerAuth = true;
      }
    }

    server.sessions.createSession(authToken || req.cookies.get(&#x27;sid&#x27;), function(err, session) {
      if(err) {
        debug(&#x27;session error&#x27;, err, session);
        throw err;
      } else {
        if (!usesBearerAuth) {
          // (re)set the session id cookie if we&#x27;re not using Authorization Bearer
          if (session.sid) req.cookies.set(&#x27;sid&#x27;, session.sid);
        }
        req.session = session;

        var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

        if (server.options.env === &#x27;development&#x27;) {
          if (root) { req.isRoot = true; }
          server.route(req, res);
        } else if (root) {
          // all root requests
          // must be authenticated
          debug(&#x27;authenticating&#x27;, root);
          server.keys.get(root, function(err, key) {
            if(err) throw err;
            if(key) req.isRoot = true;
            debug(&#x27;is root?&#x27;, session.isRoot);
            server.route(req, res);
          });
        } else {
          // normal route
          server.route(req, res);
        }
      }
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
configLoader.loadConfig = sinon.spy();
server.route(req, res);

expect(configLoader.loadConfig.callCount).to.equal(1);
        });


        it(&#x27;.<span class="apidocCodeKeywordSpan">handleRequest</span>(): should set a resources array on the server&#x27;,
function () {
var server = attach(fakeHttpServer, opts);
var req = {url: &#x27;foo&#x27;, headers: {accept: &#x27;*&#x27;}};
var res = {body: &#x27;bar&#x27;, on: function () {}};

configLoader.loadConfig = function (path, server, callback) {
    callback.call(server, null, [&#x27;foo&#x27;]);
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.prototype.listen" id="apidoc.element.deployd.server.prototype.listen">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>listen
        <span class="apidocSignatureSpan">(port, host)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">listen = function (port, host) {
  var server = this;
  var serverpath = server.options.server_dir || fs.realpathSync(&#x27;./&#x27;);

  config.loadConfig(serverpath, server, function(err, resourcesInstances) {
    if (err) {
      console.error();
      console.error(&#x22;Error loading resources: &#x22;);
      console.error(err.stack || err);
      process.exit(1);
    } else {
      server.resources = resourcesInstances;
      var router = new Router(resourcesInstances, server);
      server.router = router;
      http.Server.prototype.listen.call(server, port || server.options.port, host || server.options.host);
    }
  });
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
options.env = program.environment || process.env.DPD_ENV || options.env;
if(options.env !== &#x27;development&#x27;) console.log(&#x27;starting in %s mode&#x27;, options.env);

if(credentials !== undefined) options.db.credentials = credentials;
var dpd = createServer(options);
dpd.on(&#x27;listening&#x27;, onListening);
dpd.on(&#x27;error&#x27;, onError);
dpd.<span class="apidocCodeKeywordSpan">listen</span>();

function onListening () {
  console.info(&#x27;listening on port&#x27;, options.port);
  var commands = repl(dpd);
  if (program.dashboard) {
    commands.dashboard();
  } else if (program.open) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.server.prototype.route" id="apidoc.element.deployd.server.prototype.route">
        function <span class="apidocSignatureSpan">deployd.server.prototype.</span>route
        <span class="apidocSignatureSpan">(req, res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function route(req, res) {
  var server = this;
  var serverpath = server.options.server_dir || &#x27;./&#x27;;

  config.loadConfig(serverpath, server, function(err, resourcesInstances) {
    if (err) throw err;
    var router = new Router(resourcesInstances, server);
    server.router = router;

    server.resources = resourcesInstances;
    router.route(req, res);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var root = req.headers[&#x27;dpd-ssh-key&#x27;] || req.cookies.get(&#x27;DpdSshKey&#x27;);

if (server.options.env === &#x27;development&#x27;) {
  if (root) {
    req.isRoot = true;
  }
  server.<span class="apidocCodeKeywordSpan">route</span>(req, res);
} else if (root) {
  // all root requests
  // must be authenticated
  debug(&#x27;authenticating&#x27;, root);
  server.keys.get(root, function(err, key) {
    if(err) throw err;
    if(key) req.isRoot = true;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.session" id="apidoc.module.deployd.session">module deployd.session</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.session.SessionStore" id="apidoc.element.deployd.session.SessionStore">
        function <span class="apidocSignatureSpan">deployd.session.</span>SessionStore
        <span class="apidocSignatureSpan">(namespace, db, sockets, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function SessionStore(namespace, db, sockets, options) {
  var self = this;

  // unique id for this store in order to identify in a cluster
  this.id = this.createUniqueIdentifier();

  this.sockets = sockets;
  this.options = options || {};
  // sessions inactive for longer than this will be cleaned up:
  this.options.maxAge = this.options.maxAge || 30 * 24 * 60 * 60 * 1000;

  if (this.options.pubClient &#x26;&#x26; this.options.subClient) {
    debug(&#x27;using pub/sub mode&#x27;);
    this.pubClient = this.options.pubClient;
    this.subClient = this.options.subClient;
  }

  // socket queue
  var socketQueue = this.socketQueue = new EventEmitter()
    , socketIndex = this.socketIndex = {};

  if (sockets) {
    if (this.subClient) {
      // subscribe to messages regarding sessions joining/leaving rooms
      // need to resync
      this.subClient.subscribe(&#x27;dpd#session#refreshrooms&#x27;);
      this.subClient.subscribe(&#x27;dpd#session#remove&#x27;);
      this.subClient.on(&#x27;message&#x27;, function(channel, message) {
        var data;
        switch (channel) {
          case &#x27;dpd#session#refreshrooms&#x27;: // another node changed rooms for a session
            data = JSON.parse(message);
            if (data.id !== self.id &#x26;&#x26; data.sid &#x26;&#x26; socketIndex[data.sid]) {
              // if we know about this session, refresh the rooms
              self.refreshSessionRooms(data.sid);
            }

            break;
          case &#x27;dpd#session#remove&#x27;: // another node removed a session
            data = JSON.parse(message);
            if (data.id !== self.id &#x26;&#x26; data.sid &#x26;&#x26; sessionIndex[data.sid]) {
              // if we know about this session, remove it from memory
              sessionIndex[data.sid]._leaveAllRooms();
              self.removeSessionFromMemory(data.sid);
            }

            break;
        }
      });
    }

    sockets.on(&#x27;connection&#x27;, function(client) {
      // NOTE: do not use set here ever, the `Cookies` api is meant to get a req, res
      // but we are just using it for a cookie parser
      var cookies = new Cookies(client.handshake)
        , sid = cookies.get(&#x27;sid&#x27;);

      var getSession = function(sid, fn) {
        // check if we already know about the session
        var session = sessionIndex[sid];
        if (session) { return fn(null, session); }
        // get the session from the store otherwise
        self.createSession(sid, function(err, session) {
          if (session.data.id === sid) return fn(null, session);
          return fn();
        });
      };

      var indexSocket = function(sid, client, session) {
        // index sockets against their session id
        socketIndex[sid] = socketIndex[sid] || {};
        socketIndex[sid][client.id] = client;
        socketQueue.emit(&#x27;socket&#x27;, client, session);

        // make sure the list of rooms to join is fresh
        self.refreshSessionRooms(sid);
      };

      if (sid) {
        getSession(sid, function(err, session) {
          if (session) {
            indexSocket(sid, client, session);
          }
        });
      }

      // Alternative way of binding session to socket connection
      // for when the sid cookie is not yet available.
      // This expects that the client emits an event with the sid.
      function setSession(data) {
        if (!data || !data.sid || typeof data.sid !== &#x27;string&#x27;) { return; }
        var sid = data.sid;

        getSession(sid, function(err, session) {
          if (session) {
            // unassign socket from previous sessions
            _.each(socketIndex, function(val) {
              delete val[client.id];
            });

            indexSocket(sid, client, session);
          }
        });
      }

      client.on(&#x27;server:setSession&#x27;, setSession);
      client.on(&#x27;server:setsession&#x27;, setSession); // allow lowercase

      client.on(&#x27;disconnect&#x27;, function() {
        // unassign socket from previous sessions
        _.each(socketIndex, function(val, sid) {
          delete val[client.id];
        });
      });
    });

    var drainQueue = function drainQueue(method, rawSocket, session) {
      var key = ...</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.user_collection" id="apidoc.module.deployd.user_collection">module deployd.user_collection</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.user_collection.user_collection" id="apidoc.element.deployd.user_collection.user_collection">
        function <span class="apidocSignatureSpan">deployd.</span>user_collection
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function UserCollection(name, options) {
  Collection.apply(this, arguments);

  if(!this.properties) {
    this.properties = {};
  }

  // username and password are required
  this.properties.username = this.properties.username || {type: &#x27;string&#x27;};
  this.properties.username.required = true;
  this.properties.password = this.properties.password || {type: &#x27;string&#x27;};
  this.properties.password.required = true;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.super_" id="apidoc.element.deployd.user_collection.super_">
        function <span class="apidocSignatureSpan">deployd.user_collection.</span>super_
        <span class="apidocSignatureSpan">(name, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Collection(name, options) {
  Resource.apply(this, arguments);
  var config = this.config;
  if(config) {
    this.properties = config.properties;
  }
  if (options) {
    this.store = options.db &#x26;&#x26; options.db.createStore(this.name);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>












</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.user_collection.prototype" id="apidoc.module.deployd.user_collection.prototype">module deployd.user_collection.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.checkHash" id="apidoc.element.deployd.user_collection.prototype.checkHash">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>checkHash
        <span class="apidocSignatureSpan">(uc, user, credentials)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">checkHash = function (uc, user, credentials) {
  // NOTE: there is no need for this to take uc as the first parameter
  var salt = user.password.substr(0, UserCollection.SALT_LEN)
    , hash = user.password.substr(UserCollection.SALT_LEN);

  return hash === uc.hash(credentials.password, salt);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
ctx.done(&#x27;bad credentials&#x27;);
      });
    }

    if (user) {
      // a user with this username exists
      delete userClone.password;
      if (uc.<span class="apidocCodeKeywordSpan">checkHash</span>(uc, user, credentials) === true) {
domain.success = true;
delete user.password; // make sure the password is not included in any sort of response

if (uc.events.Login) {
  uc.events.Login.run(ctx, domain, loginDone);
} else {
  loginDone();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.getUserAndPasswordHash" id="apidoc.element.deployd.user_collection.prototype.getUserAndPasswordHash">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>getUserAndPasswordHash
        <span class="apidocSignatureSpan">(user)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getUserAndPasswordHash = function (user) {
  return crypto.createHash(&#x27;md5&#x27;).update(user.username + user.password).digest(&#x27;hex&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        // raw store query, need unmodified username and password
        return uc.store.find({id: ctx.session.data.uid, $fields: {username: 1, password: 1}}, function(err, user) {
if (err) {
  console.error(&#x22;Internal Error: &#x22; + JSON.stringify(err));
  return ctx.done({statusCode: 500, message: &#x22;Error retrieving user for verification&#x22;});
}

var userHash = user ? uc.<span class="apidocCodeKeywordSpan">getUserAndPasswordHash</span>(user) : null;

// verify that the username and password haven&#x27;t changed since this session was created
if (ctx.session.data.userhash === userHash) {
  // hash verified, call find() now to ensure all event scripts are executed
  return uc.find(ctx, function(err, user){
    if (!user) return noSuchUser(); // if the request was cancelled by the event script
    delete user.password;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.handle" id="apidoc.element.deployd.user_collection.prototype.handle">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>handle
        <span class="apidocSignatureSpan">(ctx)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handle = function (ctx) {
  var uc = this;

  if (ctx.req.method == &#x22;GET&#x22; &#x26;&#x26; (ctx.url === &#x27;/count&#x27; || ctx.url.indexOf(&#x27;/index-of&#x27;) === 0)) {
    return Collection.prototype.handle.apply(uc, arguments);
  }

  if(ctx.url === &#x27;/logout&#x27;) {
    var logoutDomain = { event: &#x22;LOGOUT&#x22; };
    uc.addDomainAdditions(logoutDomain);
    uc.doBeforeRequestEvent(ctx, logoutDomain, function(err) {
      if (err) return ctx.done(err);
      if (ctx.res.cookies) ctx.res.cookies.set(&#x27;sid&#x27;, null, {overwrite: true});
      ctx.session.remove(ctx.done);
    });
    return;
  }

  // set id if one wasnt provided in the query
  ctx.query.id = ctx.query.id || this.parseId(ctx) || (ctx.body &#x26;&#x26; ctx.body.id);

  // make sure password will never be included
  if(ctx.query.$fields) {
    var omit = true;
    for (var field in ctx.query.$fields) {
      if (ctx.query.$fields.hasOwnProperty(field) &#x26;&#x26; ctx.query.$fields[field] &#x3e; 0) {
        omit = false;
        if (&#x27;password&#x27; in ctx.query.$fields) delete ctx.query.$fields.password;
      }
      break;
    }
    if (omit || Object.keys(ctx.query.$fields).length === 0) ctx.query.$fields.password = 0;
  } else ctx.query.$fields = {password: 0};

  switch(ctx.req.method) {
    case &#x27;GET&#x27;:
      if(ctx.url === &#x27;/me&#x27;) {
        debug(&#x27;session %j&#x27;, ctx.session.data);
        var noSuchUser = function () {
          // set no-cache headers
          ctx.res.setHeader(&#x22;Cache-Control&#x22;, &#x22;no-cache, no-store, must-revalidate&#x22;);
          ctx.res.setHeader(&#x22;Pragma&#x22;, &#x22;no-cache&#x22;);
          ctx.res.setHeader(&#x22;Expires&#x22;, &#x22;0&#x22;);
          ctx.res.statusCode = 204;
          return ctx.done();
        };

        if(!(ctx.session &#x26;&#x26; ctx.session.data &#x26;&#x26; ctx.session.data.uid)) {
          return noSuchUser();
        }

        ctx.query = ctx.query || {};
        ctx.query.id = ctx.session.data.uid;

        // raw store query, need unmodified username and password
        return uc.store.find({id: ctx.session.data.uid, $fields: {username: 1, password: 1}}, function(err, user) {
          if (err) {
            console.error(&#x22;Internal Error: &#x22; + JSON.stringify(err));
            return ctx.done({statusCode: 500, message: &#x22;Error retrieving user for verification&#x22;});
          }

          var userHash = user ? uc.getUserAndPasswordHash(user) : null;

          // verify that the username and password haven&#x27;t changed since this session was created
          if (ctx.session.data.userhash === userHash) {
            // hash verified, call find() now to ensure all event scripts are executed
            return uc.find(ctx, function(err, user){
              if (!user) return noSuchUser(); // if the request was cancelled by the event script
              delete user.password;
              ctx.done.apply(null, arguments);
            });
          } else {
            noSuchUser();
          }
        });
      }

      this.find(ctx, ctx.done);
    break;
    case &#x27;POST&#x27;:
      if(ctx.url === &#x27;/login&#x27;) {
        var loginDomain = { event: &#x22;LOGIN&#x22; };
        uc.addDomainAdditions(loginDomain);
        uc.doBeforeRequestEvent(ctx, loginDomain, function(err) {
          if (err) return ctx.done(err);
          uc.handleLogin(ctx);
        });
        break;
      }
<span class="apidocCodeCommentSpan">      /* falls through */
</span>    case &#x27;PUT&#x27;:
      if (!ctx.body &#x26;&#x26; typeof ctx.body !== &#x22;object&#x22;) {
        return ctx.done(&#x22;Missing request body&#x22;);
      }
      this.setPassword(ctx.body);
      var isSelf = ctx.session.user &#x26;&#x26; ctx.session.user.id === ctx.query.id || (ctx.body &#x26;&#x26; ctx.body.id);
      if ((ctx.query.id || ctx.body.id) &#x26;&#x26; ctx.body &#x26;&#x26; !isSelf &#x26;&#x26; !ctx.session.isRoot &#x26;&#x26; !ctx.req.internal) {
        delete ctx.body.username;
        delete ctx.body.password;
      }

      function done(err, res) {
        if (res) delete res.password;
        ctx.done(err, res);
      }

      if(ctx.query.id || ctx.body.id) {
        this.save(ctx, done);
      } else {
        this.store.first({username: ctx.body.username}, function (err, u) {
          if(u) return ctx.done({errors: {username: &#x27;is already in use&#x27;}});
          uc.save(ctx, done);
        });
      }
    break;
    cas ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var doSettle = function (settledState, value) {
    state = settledState;
    // persist for handlers registered after settling
    outcome = value;

    thenHandlers.forEach(function (then) {
        then.<span class="apidocCodeKeywordSpan">handle</span>(state, outcome);
    });

    // Discard all references to handlers to be garbage collected
    thenHandlers = null;
};

var doFulfill = function (value) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.handleLogin" id="apidoc.element.deployd.user_collection.prototype.handleLogin">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>handleLogin
        <span class="apidocSignatureSpan">(ctx)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handleLogin = function (ctx) {
  var uc = this
    , path = uc.path
    , credentials = ctx.req.body || {};

  debug(&#x27;trying to login as %s&#x27;, credentials.username);
<span class="apidocCodeCommentSpan">  /* jshint eqnull:true */
</span>  // disable the jshint warning about needing === below
  // this checks whether the values are either null or undefined
  if (credentials.username == null || typeof credentials.username !== &#x27;string&#x27; || credentials.password == null || typeof credentials
.password !== &#x27;string&#x27;) {
    ctx.res.statusCode = 400;
    ctx.done(&#x27;username or password not specified&#x27;);
    return;
  }

  this.loginFindUser(ctx, function (err, user) {
    if (err) return ctx.done(err);
    // keep a clone of the user so we can compare it later to see if any changes were made in the login event
    var userClone = user ? _.clone(user) : null
      , domain = { &#x27;me&#x27;: userClone, &#x27;data&#x27;: userClone, &#x27;success&#x27;: false };
    var usernameAndPasswordHash = user ? uc.getUserAndPasswordHash(user) : null;

    // checks if the user was changed in the login event and saves it if it was
    function checkAndSaveUser(fn) {
      if (user &#x26;&#x26; !_.isEqual(userClone, user)) {
        // something was changed, need to update the user
        debug(&#x27;detected that user %s was updated from login event, saving...&#x27;, credentials.username);
        // create a new context and set the body to our user so that we can call save on the collection
        var newCtx = _.clone(ctx);
        newCtx.body = userClone;
        // skip events when calling uc.save, so that validate and put is not called from this
        // internal call
        newCtx._internalSkipEvents = true;
        newCtx.query = { id: user.id };
        // disable changing the username from this event
        if (newCtx.body.username) delete newCtx.body.username;
        if (newCtx.body.id) delete newCtx.body.id; // remove id from body

        uc.save(newCtx, fn);
      } else {
        fn();
      }
    }

    function loginDone(err) {
      if (err) return ctx.done(err);
      checkAndSaveUser(function (err) {
        if (err) return ctx.done(err);
        debug(&#x27;logged in as %s&#x27;, credentials.username);
        ctx.session.set({ path: path, uid: user.id, userhash: usernameAndPasswordHash }).save(function (err, session) {
          if (err) return ctx.done(&#x22;Internal error&#x22;);
          uc.setSessionId(ctx, session.id);
          ctx.done(err, { path: session.path, id: session.id, uid: session.uid });
        });
      });
    }

    function loginFail(err) {
      checkAndSaveUser(function () {
        if (err) return ctx.done(err); // allow overriding of error message from event
        ctx.res.statusCode = 401;
        ctx.done(&#x27;bad credentials&#x27;);
      });
    }

    if (user) {
      // a user with this username exists
      delete userClone.password;
      if (uc.checkHash(uc, user, credentials) === true) {
        domain.success = true;
        delete user.password; // make sure the password is not included in any sort of response

        if (uc.events.Login) {
          uc.events.Login.run(ctx, domain, loginDone);
        } else {
          loginDone();
        }
        return;
      }
    }

    if (uc.events.Login) {
      uc.events.Login.run(ctx, domain, loginFail);
    } else {
      loginFail();
    }
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
break;
case &#x27;POST&#x27;:
  if(ctx.url === &#x27;/login&#x27;) {
    var loginDomain = { event: &#x22;LOGIN&#x22; };
    uc.addDomainAdditions(loginDomain);
    uc.doBeforeRequestEvent(ctx, loginDomain, function(err) {
      if (err) return ctx.done(err);
      uc.<span class="apidocCodeKeywordSpan">handleLogin</span>(ctx);
    });
    break;
  }
  /* falls through */
case &#x27;PUT&#x27;:
  if (!ctx.body &#x26;&#x26; typeof ctx.body !== &#x22;object&#x22;) {
    return ctx.done(&#x22;Missing request body&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.handleSession" id="apidoc.element.deployd.user_collection.prototype.handleSession">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>handleSession
        <span class="apidocSignatureSpan">(ctx, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handleSession = function (ctx, fn) {
  // called when any session has been created
  var session = ctx.session
    , path = this.path
    , uc = this;

  if(session &#x26;&#x26; session.data &#x26;&#x26; session.data.path == path &#x26;&#x26; session.data.uid) {
    this.store.find({ id: session.data.uid }, function (err, user) {
      if (user) {
        var userHash = uc.getUserAndPasswordHash(user);
        delete user.password;
        // verify that the username and password haven&#x27;t changed since this session was created
        if (session.data.userhash === userHash) {
          session.user = user;
        } else {
          ctx.res.setHeader(&#x27;X-Session-Invalidated&#x27;, &#x27;true&#x27;);
        }
      }
      fn(err);
    });
  } else {
    fn();
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

req._routed = true;

async.series([function(fn) {
  async.forEach(router.resources, function(resource, fn) {
    if(resource.handleSession) {
      var ctx = new Context(resource, req, res, server);
      resource.<span class="apidocCodeKeywordSpan">handleSession</span>(ctx, fn);
    } else {
      fn();
    }
  }, fn);
}], function(err) {
  if (err) throw err;
  nextResource();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.hash" id="apidoc.element.deployd.user_collection.prototype.hash">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>hash
        <span class="apidocSignatureSpan">(password, salt)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hash = function (password, salt) {
  if (password &#x26;&#x26; !isNaN(password)){
    password = password.toString();
  }
  return crypto.createHmac(&#x27;sha256&#x27;, salt).update(password).digest(&#x27;hex&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
*/
UserCollection.prototype.setPassword = function (body) {
 // do not add salt to empty string
 if(!body || !body.password || typeof body.password !== &#x27;string&#x27; || body.password.length &#x3c; 1) {
     return;
 }
 var salt = uuid.create(UserCollection.SALT_LEN);
 body.password = salt + this.<span class="apidocCodeKeywordSpan">hash</span>(body.password, salt);
};

/**
* Hashes a password with the specified salt.
* @param  {string} password The password.
* @param  {string} salt     The salt.
* @return {string}          The hash, as a hex digest.
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.loginFindUser" id="apidoc.element.deployd.user_collection.prototype.loginFindUser">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>loginFindUser
        <span class="apidocSignatureSpan">(ctx, fn)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">loginFindUser = function (ctx, fn) {
  var credentials = ctx.req.body || { };
  return this.store.first({ username: credentials.username }, fn);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  // this checks whether the values are either null or undefined
  if (credentials.username == null || typeof credentials.username !== &#x27;string&#x27; || credentials.password == null || typeof
 credentials.password !== &#x27;string&#x27;) {
ctx.res.statusCode = 400;
ctx.done(&#x27;username or password not specified&#x27;);
return;
  }

  this.<span class="apidocCodeKeywordSpan">loginFindUser</span>(ctx, function (err, user) {
if (err) return ctx.done(err);
// keep a clone of the user so we can compare it later to see if any changes were made in the login event
var userClone = user ? _.clone(user) : null
  , domain = { &#x27;me&#x27;: userClone, &#x27;data&#x27;: userClone, &#x27;success&#x27;: false };
var usernameAndPasswordHash = user ? uc.getUserAndPasswordHash(user) : null;

// checks if the user was changed in the login event and saves it if it was
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.setPassword" id="apidoc.element.deployd.user_collection.prototype.setPassword">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>setPassword
        <span class="apidocSignatureSpan">(body)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setPassword = function (body) {
  // do not add salt to empty string
  if(!body || !body.password || typeof body.password !== &#x27;string&#x27; || body.password.length &#x3c; 1) {
      return;
  }
  var salt = uuid.create(UserCollection.SALT_LEN);
  body.password = salt + this.hash(body.password, salt);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			this.ctx.query = {username: &#x22;Foo&#x22;, password: Math.random()};

			this.ctx.req.url = &#x27;/users&#x27;;
			this.ctx.req.method = &#x27;POST&#x27;;
			this.ctx.req.body.username = &#x27;foo@bar.com&#x27;;
			this.ctx.req.body.password = Math.random();
			// hash the password so we can use it in our mocked loginFindUser function below
			this.uc.<span class="apidocCodeKeywordSpan">setPassword</span>(this.ctx.req.body);
			var hashedPassword = this.ctx.req.body.password;
			// reset it as plain test
			this.ctx.req.body.password = Math.random();

			this.uc.loginFindUser = function (ctx, fn) {
			  expect(ctx.req.body).to.eql({ username: &#x27;foo@bar.com&#x27;, password: &#x27;abcd&#x27; });
			  fn(null, { id: &#x27;123&#x27;, username: &#x27;foo@bar.com&#x27;, password: hashedPassword });
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.deployd.user_collection.prototype.setSessionId" id="apidoc.element.deployd.user_collection.prototype.setSessionId">
        function <span class="apidocSignatureSpan">deployd.user_collection.prototype.</span>setSessionId
        <span class="apidocSignatureSpan">(ctx, sessionId)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setSessionId = function (ctx, sessionId) {
  // dpd internal client does not have res.cookies
  if (ctx.res.cookies) ctx.res.cookies.set(&#x27;sid&#x27;, sessionId, { overwrite: true });
  if (ctx.res.setHeader) ctx.res.setHeader(&#x27;X-Session-Token&#x27;, sessionId);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

function unwrapPromise(promise, fn) {
  return promise
  .then(function (res) {
    var sessionId = res.raw.getResponseHeader(&#x22;X-Session-Token&#x22;);
    if (sessionId) {
      window.dpd.<span class="apidocCodeKeywordSpan">setSessionId</span>(sessionId);
    }
    return res;
  })
  .then(function (res) {
    returnSuccess(fn)(res.data);
    return res.data;
  })
...</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.deployd.uuid" id="apidoc.module.deployd.uuid">module deployd.uuid</a></h1>


    <h2>
        <a href="#apidoc.element.deployd.uuid.create" id="apidoc.element.deployd.uuid.create">
        function <span class="apidocSignatureSpan">deployd.uuid.</span>create
        <span class="apidocSignatureSpan">(length)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create = function (length) {
  length = length || 16;
  var hexDigits = &#x22;0123456789abcdef&#x22;;
  var s = crypto.randomBytes(length).toString(&#x27;hex&#x27;).split(&#x27;&#x27;); // convert string to array
  s.length = length; // trim to length if bigger

  s[length - 3] = hexDigits.substr((s[length - 3] &#x26; 0x3) | 0x8, 1);

  // return the uuid
  return s.join(&#x27;&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
## 0.6.3

 - Removed dependency on jQuery for dpd.js
 - JSON-formatted &#x22;bad credentials&#x22; login error
 - Improved error reporting on CLI when port is in use
 - If in development mode, and no port has been specifically requested, CLI will retry with up to 5 different ports
 - Fixed &#x22;no open connections&#x22; bug on startup
 - Renamed `Db.connect()` to `Db.<span class="apidocCodeKeywordSpan">create</span>()`
 - Db connections are now lazy and only occur once a request is made
 - Added 500 and 404 error pages
 - Added module domain error handling for better module errors
 - Added automatic reloading on error
 - Dropped support for node 0.6

## 0.6.2
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
